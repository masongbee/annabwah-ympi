<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');
/**
 * Class	: M_hitungpresensi
 * 
 * Table	: hitungpresensi
 *  
 * @author masongbee
 *
 */
class M_hitungpresensi extends CI_Model{

	function __construct(){
		parent::__construct();		
	}
	
	/**
	 * Fungsi	: getAll
	 * 
	 * Untuk mengambil all-data
	 * 
	 * @param number $start
	 * @param number $page
	 * @param number $limit
	 * @return json
	 */
	 
	function ProcessInit(){
		// --------------------- Proses 1 Inisialisasi HitungPresensi
		
	}
	
	public function getProsesHitpres()
	{
		$totalData = $this->db->get_where('init',array('PARAMETER' => 'Total Data Hit'))->result();
		$totalProses = $this->db->get_where('init',array('PARAMETER' => 'CounterHit'))->result();
		$json	= array(
			'success'   => TRUE,
			'message'   => 'Total Data...',
			'totalData' => $totalData[0]->VALUE,
			'totalProses' => $totalProses[0]->VALUE
		);
		
		return $json;
	}
	
	function ProcessUpdate($tglmulai,$tglsampai){
		// --------------------- Proses 2 Update Untuk JamKerja Bersih setelah dipotong MakanSiang / MakanMalam
		/*$sql1 = "UPDATE hitungpresensi t1
		JOIN (
			SELECT t2.nik, DATE(t2.tjmasuk) as TANGGAL, MIN(t2.TJMASUK) AS TJMASUK, MAX(t2.TJKELUAR) AS TJKELUAR, SUM(TIMESTAMPDIFF(MINUTE,t2.TJMASUK,t2.TJKELUAR)) AS JAMKERJA,
			IF((
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'))AND(TIMESTAMP(MAX(t2.TJKELUAR))< TIMESTAMP(DATE(t2.TJMASUK),'18:00:00')),60,0)))=0,
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'18:30:00'),30,0)),
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),60,0))) AS POTONGMAKAN,
			(SUM(TIMESTAMPDIFF(MINUTE,t2.TJMASUK,t2.TJKELUAR)) - (IF((
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'))AND(TIME(t2.TJKELUAR)< TIMESTAMP(DATE(t2.TJMASUK),'18:00:00')),60,0)))=0,
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'18:30:00'),30,0)),
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),60,0))))) AS JAMBERSIH
			FROM presensi t2
			WHERE t2.TJMASUK >= DATE('$tglmulai') and t2.TJKELUAR <= DATE('$tglsampai')
			GROUP BY t2.NIK, DATE(t2.TJMASUK)) AS t3
		ON t1.NIK=t3.nik AND t1.TANGGAL=t3.TANGGAL
		SET 
			t1.JENISABSEN=IF((IF(t3.JAMBERSIH > 0,1,0)) = 1,'HD','AL'),
			t1.HARIKERJA = IF(t3.JAMBERSIH > 0,1,0),
			t1.JAMKERJA = t3.JAMBERSIH,
			t1.JAMLEMBUR = 0,
			t1.JAMKURANG = 0,
			t1.JAMBOLOS = 0,
			t1.EXTRADAY = 0,
			t1.TERLAMBAT = 'T',
			t1.PLGLBHAWAL = 'T',
			t1.JENISLEMBUR = null
			;";
		$query1 = $this->db->query($sql1);
		
		// ----------------- 04-07-2013 Proses 3 Update untuk JAMKERJA, JAMLEMBUR, JENISLEMBUR, EXTRADAY -----------------
		$sql2 = "UPDATE hitungpresensi t5
		JOIN (
			SELECT DATE(t1.TJMASUK) as TANGGAL, t1.NIK, t1.TJMASUK, MAX(t1.TJKELUAR) as JAMKELUAR,t4.TJMASUK as TJLEMBUR, SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, 
			SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as LEMBURKOTOR,
			IF((
			IF(TIMESTAMP(MAX(t1.TJKELUAR)) < TIMESTAMP(DATE(t4.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t1.TJKELUAR)) > TIMESTAMP(DATE(t4.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t1.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t1.TJKELUAR))> TIMESTAMP(DATE(t4.TJMASUK),'13:00:00'))AND(TIMESTAMP(MAX(t1.TJKELUAR))< TIMESTAMP(DATE(t4.TJMASUK),'18:00:00')),60,0)))=0,
			IF(TIMESTAMP(MAX(t1.TJKELUAR)) < TIMESTAMP(DATE(t4.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t1.TJKELUAR)) > TIMESTAMP(DATE(t4.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t1.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t1.TJKELUAR))> TIMESTAMP(DATE(t4.TJMASUK),'18:30:00'),30,0)),
			IF(TIMESTAMP(MAX(t1.TJKELUAR)) < TIMESTAMP(DATE(t4.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t1.TJKELUAR)) > TIMESTAMP(DATE(t4.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t1.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t1.TJKELUAR))> TIMESTAMP(DATE(t4.TJMASUK),'13:00:00'),60,0))) AS POTONGMAKAN,
			(SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) - (IF((
			IF(TIMESTAMP(MAX(t1.TJKELUAR)) < TIMESTAMP(DATE(t4.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t1.TJKELUAR)) > TIMESTAMP(DATE(t4.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t1.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t1.TJKELUAR))> TIMESTAMP(DATE(t4.TJMASUK),'13:00:00'))AND(TIME(t1.TJKELUAR)< TIMESTAMP(DATE(t4.TJMASUK),'18:00:00')),60,0)))=0,
			IF(TIMESTAMP(MAX(t1.TJKELUAR)) < TIMESTAMP(DATE(t4.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t1.TJKELUAR)) > TIMESTAMP(DATE(t4.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t1.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t1.TJKELUAR))> TIMESTAMP(DATE(t4.TJMASUK),'18:30:00'),30,0)),
			IF(TIMESTAMP(MAX(t1.TJKELUAR)) < TIMESTAMP(DATE(t4.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t1.TJKELUAR)) > TIMESTAMP(DATE(t4.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t1.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t1.TJKELUAR))> TIMESTAMP(DATE(t4.TJMASUK),'13:00:00'),60,0))))) AS JAMLEMBUR,
			t4.JENISLEMBUR,
			IF(t4.JENISLEMBUR = 'B',0,1) AS EXTRADAY,
			SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
			FROM presensi t1
				JOIN (
				SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK, t3.JENISLEMBUR
				FROM splembur t2
				RIGHT JOIN rencanalembur t3
				ON t2.NOLEMBUR = t3.NOLEMBUR AND DATE(t3.TJMASUK)>=DATE('$tglmulai') AND DATE(t3.TJMASUK)<=DATE('$tglsampai') ) as t4
			ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
			GROUP BY t1.NIK,DATE(t1.TJMASUK)) as t6
			ON t5.NIK=t6.NIK AND t5.TANGGAL=t6.TANGGAL
		SET
			t5.JENISABSEN=IF((IF(t6.JAMKERJA > 0,1,0)) = 1,'HD','AL'),
			t5.JAMKERJA=(t6.JAMKERJA/60),
			t5.JAMLEMBUR=(t6.JAMLEMBUR/60),
			t5.JENISLEMBUR=t6.JENISLEMBUR,
			t5.EXTRADAY=t6.EXTRADAY;";
		$query2 = $this->db->query($sql2);

		// -----------------------------------------------------
		*/
		// ----------------- 05-07-2013 Proses 4 Update untuk JENISABSEN, HARIKERJA, JAMKURANG, TERLAMBAT, PLGLBHAWAL -----------------
		/*$sql3 = "UPDATE hitungpresensi t9
		JOIN (
		SELECT t8.KODESHIFT,t8.NAMASHIFT,t8.SHIFTKE,t8.JAMDARI,t8.JAMSAMPAI,t8.TOTALJAM,t7.NIK,DATE(MIN(t7.TJMASUK))AS TANGGAL,t8.JENISHARI,MIN(t7.TJMASUK)AS JAMMASUK,MAX(t7.TJKELUAR)AS JAMKELUAR,
		SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) AS JAMKERJA,
		IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIMESTAMP(MAX(t7.TJKELUAR))< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))))) AS JAMBERSIH,
		IF((t8.TOTALJAM-(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0)))))) >=0,(t8.TOTALJAM-(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0)))))),0) AS JAMKURANG,
		IF((MIN(t7.TJMASUK)) > TIMESTAMP(DATE(t7.TJMASUK),t8.JAMDARI),'Y','T') as TERLAMBAT,
		IF((MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),t8.JAMSAMPAI),'Y','T') as PLGLBHAWAL
		FROM presensi t7
		JOIN (
			SELECT t5.VALIDTO, t6.KODESHIFT, t6.NIK, t5.NAMASHIFT, t5.SHIFTKE,t5.JENISHARI, t5.JAMDARI, t5.JAMSAMPAI, ((HOUR(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))*60) + MINUTE(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI)) - 60) as TOTALJAM, t5.TGLMULAI, t5.TGLSAMPAI
			FROM karyawanshift t6
			JOIN (
				SELECT t4.VALIDTO, t4.KODESHIFT, t1.NAMASHIFT, t1.SHIFTKE, t1.JENISHARI, t1.JAMDARI, t1.JAMSAMPAI, t4.TGLMULAI,t4.TGLSAMPAI
				FROM shiftjamkerja t1
				JOIN (
				SELECT t3.KODESHIFT, t2.NAMASHIFT, t3.SHIFTKE, t2.VALIDTO, t3.TGLMULAI, t3.TGLSAMPAI
				FROM shift t2
				RIGHT JOIN pembagianshift t3
				ON t2.NAMASHIFT=t3.NAMASHIFT) as t4
				ON t1.NAMASHIFT=t4.namashift AND t1.SHIFTKE=t4.SHIFTKE) as t5
			ON t5.KODESHIFT = t6.KODESHIFT ) as t8
		ON t7.NIK=t8.NIK AND DATE(t7.TJMASUK) <= DATE(t8.TGLSAMPAI) AND DATE(t7.TJMASUK) >= DATE(t8.TGLMULAI) AND (t8.JENISHARI = (IF(DAYNAME(DATE(t7.TJMASUK)) = 'Friday','J','N')))
		GROUP BY t7.NIK,DATE(t7.TJMASUK), t8.JENISHARI) AS t10
		ON t9.NIK=t10.NIK AND t9.TANGGAL=t10.TANGGAL AND DATE(t10.TANGGAL)>=DATE('$tglmulai') AND DATE(t10.TANGGAL)<=DATE('$tglsampai')
		SET
			t9.JENISABSEN=IF((IF(t10.JAMBERSIH > 0,1,0)) = 1,'HD','AL'),
			T9.JAMBOLOS=IF(T9.JENISABSEN = 'AL',480,0),
			t9.HARIKERJA=IF(t10.JAMBERSIH > 0,1,0),
			t9.JAMKERJA=t10.JAMBERSIH,
			t9.JAMKURANG=t10.JAMKURANG,
			t9.TERLAMBAT=t10.TERLAMBAT,
			t9.PLGLBHAWAL=t10.PLGLBHAWAL;";
			
			
		* ------------------------------- 21-07-2013 Revisi JamRehat pada shiftjamkerja --------------------------
		SELECT t8.KODESHIFT,t8.NAMASHIFT,t8.SHIFTKE,t8.JAMDARI,t8.JAMSAMPAI,t8.TOTALJAM,t7.NIK,DATE(t7.TJMASUK)AS TANGGAL,
		t8.JENISHARI,t7.TJMASUK AS JAMMASUK,MAX(t7.TJKELUAR)AS JAMKELUAR,
		SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) AS JAMKERJA, 
		IF(t8.JENISHARI ='N',(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3S)),0)),(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3S)),0))) as POTONGISTIRAHAT,
		(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR))-IF(t8.JENISHARI ='N',(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3S)),0)),(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3S)),0)))) AS JAMBERSIH,
		IF(((SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR))-IF(t8.JENISHARI ='N',(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3S)),0)),(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3S)),0))))<t8.TOTALJAM),(t8.TOTALJAM-(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR))-IF(t8.JENISHARI ='N',(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3S)),0)),(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT1S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT2S)),0))+(IF(TIME(t7.TJKELUAR)>t8.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3M),TIMESTAMP(DATE(t7.TJMASUK),t8.JAMREHAT3S)),0))))),0) AS JAMKURANG,
		IF(t7.TJMASUK > TIMESTAMP(DATE(t7.TJMASUK),t8.JAMDARI),TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMDARI),t7.TJMASUK),0) AS TERLAMBAT,
		IF(t7.TJKELUAR < TIMESTAMP(DATE(t7.TJMASUK),t8.JAMSAMPAI),TIMESTAMPDIFF(MINUTE,t7.TJKELUAR,TIMESTAMP(DATE(t7.TJMASUK),t8.JAMSAMPAI)),0) AS PLGLBHAWAL
		FROM presensi t7 
		JOIN (
			SELECT t5.VALIDTO, t6.KODESHIFT, t6.NIK, t5.NAMASHIFT, t5.SHIFTKE,t5.JENISHARI, t5.JAMDARI, t5.JAMSAMPAI, 
			((HOUR(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))*60) + MINUTE(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI)) - (IF(t5.JENISHARI ='J',90,60))) as TOTALJAM, 
			t5.TGLMULAI, t5.TGLSAMPAI, t5.JAMREHAT1M,t5.JAMREHAT1S, t5.JAMREHAT2M,t5.JAMREHAT2S, t5.JAMREHAT3M,t5.JAMREHAT3S
			FROM karyawanshift t6
			JOIN (
				SELECT t4.VALIDTO, t4.KODESHIFT, t1.NAMASHIFT, t1.SHIFTKE, t1.JENISHARI, t1.JAMDARI, t1.JAMSAMPAI, t4.TGLMULAI,t4.TGLSAMPAI,t1.JAMREHAT1M,t1.JAMREHAT1S,
				t1.JAMREHAT2M,t1.JAMREHAT2S,t1.JAMREHAT3M,t1.JAMREHAT3S
				FROM shiftjamkerja t1
				JOIN (
				SELECT t3.KODESHIFT, t2.NAMASHIFT, t3.SHIFTKE, t2.VALIDTO, t3.TGLMULAI, t3.TGLSAMPAI
				FROM shift t2
				RIGHT JOIN pembagianshift t3
				ON t2.NAMASHIFT=t3.NAMASHIFT) as t4
				ON t1.NAMASHIFT=t4.namashift AND t1.SHIFTKE=t4.SHIFTKE) as t5
			ON t5.KODESHIFT = t6.KODESHIFT ) as t8
		ON t7.NIK=t8.NIK AND DATE(t7.TJMASUK) <= DATE(t8.TGLSAMPAI) AND DATE(t7.TJMASUK) >= DATE(t8.TGLMULAI) AND (t8.JENISHARI = (IF(DAYNAME(DATE(t7.TJMASUK)) = 'Friday','J','N')))
		GROUP BY t7.NIK,DATE(t7.TJMASUK), t8.JENISHARI
		
		* -----------------------------------------
			
		
		
		*/
		
		$sql3 = "UPDATE hitungpresensi hp
		JOIN (
			SELECT t1.VALIDFROM,t1.VALIDTO,p.NAMASHIFT,p.NIK,p.SHIFTKE,p.TANGGAL,t1.JAMDARI,t1.JAMSAMPAI,t1.JENISHARI,p.TJMASUK,p.TJKELUAR,
			(TIMESTAMPDIFF(MINUTE,p.TJMASUK,p.TJKELUAR)) AS TOTALJAM,
			((TIMESTAMPDIFF(MINUTE,p.TJMASUK,p.TJKELUAR))-IF(t1.JENISHARI ='N',(IF(TIME(p.TJKELUAR)>t1.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3S)),0)),(IF(TIME(p.TJKELUAR)>t1.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3S)),0)))) AS JAMBERSIH,
			IF(p.TJMASUK > TIMESTAMP(DATE(p.TJMASUK),t1.JAMDARI),TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMDARI),p.TJMASUK),0) AS TERLAMBAT,
			IF(p.TJKELUAR < TIMESTAMP(DATE(p.TJMASUK),t1.JAMSAMPAI),TIMESTAMPDIFF(MINUTE,p.TJKELUAR,TIMESTAMP(DATE(p.TJMASUK),t1.JAMSAMPAI)),0) AS PLGLBHAWAL,
			(IF(p.TJMASUK > TIMESTAMP(DATE(p.TJMASUK),t1.JAMDARI),TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMDARI),p.TJMASUK),0)+IF(p.TJKELUAR < TIMESTAMP(DATE(p.TJMASUK),t1.JAMSAMPAI),TIMESTAMPDIFF(MINUTE,p.TJKELUAR,TIMESTAMP(DATE(p.TJMASUK),t1.JAMSAMPAI)),0)) AS JAMKURANG,
			IF(t1.JENISHARI ='N',(IF(TIME(p.TJKELUAR)>t1.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3S)),0)),(IF(TIME(p.TJKELUAR)>t1.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3S)),0))) as POTONGISTIRAHAT
			FROM presensi p 
			JOIN (
				SELECT
					s.VALIDFROM,s.VALIDTO,sj.NAMASHIFT,sj.SHIFTKE,sj.JENISHARI,sj.JAMDARI,sj.JAMSAMPAI,sj.JAMREHAT0M,sj.JAMREHAT0S,
					sj.JAMREHAT1M,sj.JAMREHAT1S,sj.JAMREHAT2M,sj.JAMREHAT2S,sj.JAMREHAT3M,sj.JAMREHAT3S,sj.JAMREHAT4M,sj.JAMREHAT4S
				FROM
					shift s
				RIGHT JOIN shiftjamkerja sj ON sj.NAMASHIFT=s.NAMASHIFT
			) AS t1 ON t1.NAMASHIFT=p.NAMASHIFT AND t1.SHIFTKE=p.SHIFTKE AND t1.JENISHARI=IF(DAYNAME(p.TANGGAL) = 'Friday','J','N')
		) AS t2
		ON t2.NIK=hp.NIK AND t2.TANGGAL=hp.TANGGAL AND (DATE(t2.TANGGAL)>=DATE('$tglmulai') AND DATE(t2.TANGGAL)<=DATE('$tglsampai'))
		SET
			hp.JENISABSEN=IF((IF(ABS((t2.JAMBERSIH-t2.POTONGISTIRAHAT)/60) > 0,1,0)) = 1,'HD','AL'),
			hp.JAMBOLOS=IF(hp.JENISABSEN = 'AL',480,0),
			hp.HARIKERJA=IF(ABS((t2.JAMBERSIH-t2.POTONGISTIRAHAT)/60) > 0,1,0),
			hp.JAMKERJA=ABS((t2.JAMBERSIH-t2.POTONGISTIRAHAT)/60),
			hp.JAMKURANG=IF(hp.JENISABSEN = 'AL',480,t2.JAMKURANG),
			hp.TERLAMBAT=t2.TERLAMBAT,
			hp.PLGLBHAWAL=t2.PLGLBHAWAL;";
		$query3 = $this->db->query($sql3);
		
			
		// ------------------------------------------ 2013-09-19 Proses Update JamLembur Awal dan Akhir -------------------------------------------
		
		$sql4 = "UPDATE hitungpresensi hp
		JOIN (
		SELECT tl.NAMASHIFT,tl.NIK,tl.SHIFTKE,tl.TANGGAL,tl.JAMDARI,tl.JAMSAMPAI,tl.TOTALJAM,tl.JENISHARI,L.TJMASUK AS JAMMSKLEMBUR,tl.TJMASUK,tl.TJKELUAR,
		tl.JAMBERSIH,tl.POTONGISTIRAHAT,TIMESTAMPDIFF(MINUTE,L.TJMASUK,tl.TJKELUAR) AS JL, L.JENISLEMBUR,
		IF(L.TJMASUK >= tl.TJMASUK,TIMESTAMPDIFF(MINUTE,L.TJMASUK,tl.TJKELUAR)-(IF(tl.TJKELUAR > tl.JAMREHAT4S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(tl.TANGGAL,tl.JAMREHAT4M),TIMESTAMP(tl.TANGGAL,tl.JAMREHAT4S)),0)),TIMESTAMPDIFF(MINUTE,L.TJMASUK,tl.TJMASUK)-(IF(tl.TJMASUK > tl.JAMREHAT0S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(tl.TANGGAL,tl.JAMREHAT0M),TIMESTAMP(tl.TANGGAL,tl.JAMREHAT0S)),0))) AS JAMLEMBUR
		FROM presensilembur L
		JOIN (
			SELECT t1.VALIDFROM,t1.VALIDTO,p.NAMASHIFT,p.NIK,p.SHIFTKE,p.TANGGAL,t1.JAMDARI,t1.JAMSAMPAI,t1.JENISHARI,p.TJMASUK,p.TJKELUAR,
			(TIMESTAMPDIFF(MINUTE,p.TJMASUK,p.TJKELUAR)) AS TOTALJAM,
			((TIMESTAMPDIFF(MINUTE,p.TJMASUK,p.TJKELUAR))-IF(t1.JENISHARI ='N',(IF(TIME(p.TJKELUAR)>t1.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3S)),0)),(IF(TIME(p.TJKELUAR)>t1.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3S)),0)))) AS JAMBERSIH,
			IF(t1.JENISHARI ='N',(IF(TIME(p.TJKELUAR)>t1.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3S)),0)),(IF(TIME(p.TJKELUAR)>t1.JAMREHAT1S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT1S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT2S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT2S)),0))+(IF(TIME(p.TJKELUAR)>t1.JAMREHAT3S,TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3M),TIMESTAMP(DATE(p.TJMASUK),t1.JAMREHAT3S)),0))) as POTONGISTIRAHAT,
			t1.JAMREHAT0M,t1.JAMREHAT0S,t1.JAMREHAT1M,t1.JAMREHAT1S,t1.JAMREHAT2M,t1.JAMREHAT2S,t1.JAMREHAT3M,t1.JAMREHAT3S,t1.JAMREHAT4M,t1.JAMREHAT4S
			FROM presensi p 
			JOIN (
				SELECT
					s.VALIDFROM,s.VALIDTO,sj.NAMASHIFT,sj.SHIFTKE,sj.JENISHARI,sj.JAMDARI,sj.JAMSAMPAI,sj.JAMREHAT0M,sj.JAMREHAT0S,
					sj.JAMREHAT1M,sj.JAMREHAT1S,sj.JAMREHAT2M,sj.JAMREHAT2S,sj.JAMREHAT3M,sj.JAMREHAT3S,sj.JAMREHAT4M,sj.JAMREHAT4S
				FROM
					shift s
				RIGHT JOIN shiftjamkerja sj ON sj.NAMASHIFT=s.NAMASHIFT
			) AS t1 ON t1.NAMASHIFT=p.NAMASHIFT AND t1.SHIFTKE=p.SHIFTKE AND t1.JENISHARI=IF(DAYNAME(p.TANGGAL) = 'Friday','J','N')
			WHERE (p.TANGGAL >= t1.VALIDFROM AND p.TANGGAL <= t1.VALIDTO)
		) tl ON tl.NIK=L.NIK AND tl.TANGGAL=DATE(L.TJMASUK)
		) LB ON hp.NIK=LB.NIK AND hp.TANGGAL=LB.TANGGAL  AND (DATE(hp.TANGGAL)>=DATE('$tglmulai') AND DATE(hp.TANGGAL)<=DATE('$tglsampai'))
		SET
			hp.JAMKERJA=LB.JAMBERSIH-LB.JAMLEMBUR,
			hp.JAMLEMBUR=(IF(MOD(LB.JAMLEMBUR,60)< 44,(LB.JAMLEMBUR - MOD(LB.JAMLEMBUR,60))+30,IF(MOD(LB.JAMLEMBUR,60) > 45,(LB.JAMLEMBUR - MOD(LB.JAMLEMBUR,60))+60,0))/60),
			hp.JENISLEMBUR=LB.JENISLEMBUR,
			hp.EXTRADAY=IF(LB.JAMLEMBUR > 0,1,0);";
		$query4 = $this->db->query($sql4);		
		
		
		// ------------------------------------------ Proses 5 Update Permohonan Ijin pada Jenis Absen
		$sql5 = "UPDATE hitungpresensi T2
		JOIN (
			SELECT T1.TANGGAL,T1.NIK,T1.JENISABSEN, T1.JAMDARI,t1.JAMSAMPAI,
			TIMESTAMPDIFF(MINUTE,TIMESTAMP(DATE(T1.TANGGAL),T1.JAMDARI),TIMESTAMP(DATE(T1.TANGGAL),T1.JAMSAMPAI)) AS TOTALIJIN
			FROM permohonanijin T1
			WHERE T1.TANGGAL >= DATE('$tglmulai') AND T1.TANGGAL <= DATE('$tglsampai')) AS T3
		ON T2.NIK=T3.NIK AND T2.TANGGAL=T3.TANGGAL
		SET	
			T2.JENISABSEN=T3.JENISABSEN,
			t2.JAMKURANG=IF(T3.JENISABSEN = 'IZ',T2.JAMKURANG+T3.TOTALIJIN,T2.JAMKURANG),
			T2.JAMBOLOS=0
			";
		$query5 = $this->db->query($sql5);
		
		// ------------------------------------------ Proses 6 Update Permohonan Cuti pada Jenis Absen
		$sql6 = "UPDATE hitungpresensi T4
		JOIN (
		SELECT t1.NOURUT,t1.NIK,t1.JENISABSEN,t1.LAMA,t1.TGLMULAI,t1.TGLSAMPAI,t1.SISACUTI
		FROM rinciancuti t1
		RIGHT JOIN permohonancuti t2
		ON t1.NOCUTI=t2.NOCUTI
		WHERE t1.TGLMULAI >= DATE('$tglmulai') AND t1.TGLSAMPAI <= DATE('$tglsampai')) AS T3
		ON T4.NIK=T3.NIK AND (T4.TANGGAL=T3.TGLMULAI OR t4.TANGGAL=T3.TGLSAMPAI)
		SET	
			T4.JENISABSEN=T3.JENISABSEN,
			T4.JAMBOLOS=0";
		$query6 = $this->db->query($sql6);
		
		// ------------------------------------------ Proses 7 Update Untuk Pembulatan JAM KURANG
		$sql7 = "UPDATE hitungpresensi hp
		SET
			JAMKURANG = (IF(MOD(JAMKURANG,60)<= 30 AND MOD(JAMKURANG,60)>=1,(JAMKURANG - MOD(JAMKURANG,60))+30,IF(MOD(JAMKURANG,60)>30 AND MOD(JAMKURANG,60)<=60,(JAMKURANG - MOD(JAMKURANG,60))+60,0))/60)";
		$query7 = $this->db->query($sql7);
		
		
		// ------------------------------------------ Proses 8 Update Untuk SATUAN LEMBUR
		$sql8 = "UPDATE hitungpresensi hp
		JOIN (
			SELECT h.TANGGAL,h.BULAN,h.NIK,h.JENISLEMBUR,h.JAMLEMBUR,l.BATAS1,l.BATAS2,l.BATAS3,l.PENGALI1,l.PENGALI2,l.PENGALI3,
			IF(h.JAMLEMBUR > l.BATAS1,IF((h.JAMLEMBUR-l.BATAS1)>l.BATAS2,IF((h.JAMLEMBUR-l.BATAS1-l.BATAS2) > l.BATAS3,(((h.JAMLEMBUR-l.BATAS1)*l.PENGALI1)+(h.JAMLEMBUR-l.BATAS1-l.BATAS2)*l.PENGALI2)+((h.JAMLEMBUR-l.BATAS1-l.BATAS2-l.BATAS3)*l.PENGALI3),(((l.BATAS1)*l.PENGALI1)+(h.JAMLEMBUR-l.BATAS1)*l.PENGALI2)),(l.BATAS1*l.PENGALI1)+((h.JAMLEMBUR-l.BATAS1)*l.PENGALI2)),l.BATAS1*l.PENGALI1) AS SATLEMBUR
			FROM hitungpresensi h
			INNER JOIN lembur l ON l.JENISLEMBUR=h.JENISLEMBUR
			WHERE (h.JENISLEMBUR IS NOT NULL) AND (h.TANGGAL >= l.VALIDFROM) AND (h.BULAN >= l.BULANMULAI AND h.BULAN <= l.BULANSAMPAI)
		) AS t1 ON t1.TANGGAL=hp.TANGGAL AND t1.NIK=hp.NIK
		SET
			hp.SATLEMBUR = t1.SATLEMBUR;";
		$query8 = $this->db->query($sql8);
	}
	
	
	
	
	function InitRecord($bulangaji){
		$bln = $bulangaji . "01";
		$this->db->select('TGLMULAI,TGLSAMPAI');
		$sql = $this->db->get_where('periodegaji',array('BULAN' => $bulangaji))->result_array();
		
		/*$TMASUK = new DateTime($sql[0]['TGLMULAI']);
		$TSAMPAI = new DateTime($sql[0]['TGLSAMPAI']);
		$TM = intval($TMASUK->format('d'));
		$TS = intval($TSAMPAI->format('d'));*/
		
		$this->db->truncate('datetemp');
		
		$tglAwal = $sql[0]['TGLMULAI'];
		$tglAkhir = $sql[0]['TGLSAMPAI'];
		$date1 = date_create($tglAwal);
		$arr1 = explode('-',$tglAwal);
		$arr2 = explode('-',$tglAkhir);
		$diff = gregoriantojd($arr2[1], $arr2[2], $arr2[0])- gregoriantojd($arr1[1], $arr1[2], $arr1[0]);
		for($k=0;$k<=$diff;$k++){                
			//echo date('Y-m-d', strtotime(date_format($date1,"Y-m-d")));
			//$this->firephp->log(date('Y-m-d', strtotime(date_format($date1,"Y-m-d"))));
			$this->db->insert('datetemp', array('tanggal'=>date('Y-m-d', strtotime(date_format($date1,'Y-m-d')))));
			date_add($date1, date_interval_create_from_date_string('1 days'));
		}
		
		$sql_init = "INSERT INTO hitungpresensi (NIK, BULAN, TANGGAL, JENISABSEN, USERNAME)
			SELECT *
			FROM presensi,datetemp
			WHERE (datetemp.tanggal BETWEEN STR_TO_DATE('20130701','%Y%m%d')
				AND STR_TO_DATE('20130702','%Y%m%d'))
				AND (STR_TO_DATE(DATE_FORMAT(TJMASUK,'%Y%m%d'),'%Y%m%d') = datetemp.tanggal)
			GROUP BY datetemp.tanggal, presensi.NIK
			ORDER BY datetemp.tanggal, presensi.NIK";
		
		/*for($i=$TM;$i<=$TS;$i++)
		{
			$sql = "insert into HITUNGPRESENSI 
					(NIK, BULAN, TANGGAL, JENISABSEN, USERNAME) 
					select NIK, $bulangaji as BULAN, '".$TMASUK->format('Y-m')."-".$i."' as TANGGAL, 'AL' as JENISABSEN,
					'".$this->session->userdata('user_name')."' as USERNAME 
					from PRESENSI 
					where DATE_FORMAT(TJMASUK,'%Y%m')=DATE_FORMAT(DATE_SUB('$bln',INTERVAL 1 MONTH),'%Y%m')
					GROUP BY NIK";
			$query = $this->db->query($sql);
			
		}*/
	}
	
	function ListLembur(){
		// Query sebelum ada potongan terkait melewati Jam Makan Siang 13.00 dan Jam Makan Malam 18.00
		/*$sql = "SELECT DATE(t1.TJMASUK) as TANGGAL, t1.NIK, t1.TJMASUK, t1.TJKELUAR,t4.TJMASUK as TJLEMBUR, sum(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as JAMLEMBUR, SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
		GROUP BY t1.NIK";*/
		
		
		// Query Setelah ada potongan terkait melewati Jam Makan Siang 13.00 dan Jam Makan Malam 18.00
		
		$sql = "SELECT DATE_FORMAT(t1.TJMASUK,'%Y-%m-%d') as TANGGAL, t1.NIK, t1.TJMASUK, t1.TJKELUAR,t4.TJMASUK as TJLEMBUR, sum(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as LEMBURKOTOR,
		IF((
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0)))=0,
		IF(TIME(t1.TJKELUAR) < TIME('18:30:00'),IF(TIME(t1.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('18:30:00'),60,0)),
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) -(IF((
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0)))=0,
		IF(TIME(t1.TJKELUAR) < TIME('18:30:00'),IF(TIME(t1.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('18:30:00'),60,0)),
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0))))) AS JAMLEMBUR,
		SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
		GROUP BY t1.NIK;";
		$query = $this->db->query($sql);
		if($query->num_rows() > 0)
		{
			//var_dump($query->result_array());
			return $query->result_array();
		}
		else
			return 0;
		//echo "<br /><br />";
	}
	
	function JamKerjaPerHari($tgl,$nik){
		$sql = "SELECT NIK, SUM(TIMESTAMPDIFF(MINUTE,tjmasuk,tjkeluar)) as JAMKERJA
				FROM presensi
				WHERE NIK=$nik AND DATE(TJMASUK)=DATE('$tgl')
				GROUP BY DATE(TJMASUK);";
		$query = $this->db->query($sql);
		
		if($query->num_rows() > 0)
		{
			$lembur = $this->ListLembur();
			$data=array();
			foreach($lembur as $v)
			{
				if($v['TANGGAL']==$tgl && $v['NIK']==$nik)
				{
					$data['JAMKERJA'] = intval($v['JAMKERJA']);
					$data['JAMLEMBUR'] = intval($v['JAMLEMBUR']);
					//return $data;
					break;
				}
				else
				{					
					$rs = $query->result_array();
					$data['JAMKERJA'] = intval($rs[0]['JAMKERJA']);
					$data['JAMLEMBUR'] = 0;
					//return $data;
				}
				//echo $v['TANGGAL']." ".$v['NIK']." ".$v['JAMKERJA']." ".$v['JAMLEMBUR']."<br />";
			}
			return $data;
		}
		else
		{
			$data['JAMKERJA'] = 0;
			$data['JAMLEMBUR'] = 0;
			return $data;
		}
	}
	
	function JamKurangPerHari($norm,$tgl,$nik){
		// Menghasilkan Data :
		// VALIDTO, KODESHIFT, NIK, NAMASHIFT,SHIFTKE, JAMDARI, JAMSAMPAI,
		// TOTALJAM(dlam menit), TGLMULAI, DAN TGLSAMPAI (dari shift yg digunakan)
		
		$sql = "SELECT t5.VALIDTO, t6.KODESHIFT, t6.NIK, t5.NAMASHIFT, t5.SHIFTKE, t5.JAMDARI, t5.JAMSAMPAI, ((HOUR(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))*60) + MINUTE(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))) as TOTALJAM, t5.TGLMULAI, t5.TGLSAMPAI
		FROM karyawanshift t6
		JOIN (
		SELECT t4.VALIDTO, t4.KODESHIFT, t1.NAMASHIFT, t1.SHIFTKE, t1.JAMDARI, t1.JAMSAMPAI, t4.TGLMULAI,t4.TGLSAMPAI
		FROM shiftjamkerja t1
		JOIN (
		SELECT t3.KODESHIFT, t2.NAMASHIFT, t3.SHIFTKE, t2.VALIDTO, t3.TGLMULAI, t3.TGLSAMPAI
		FROM shift t2
		RIGHT JOIN pembagianshift t3
		ON t2.NAMASHIFT=t3.NAMASHIFT) as t4
		ON t1.NAMASHIFT=t4.namashift AND t1.SHIFTKE=t4.SHIFTKE) as t5
		ON t5.KODESHIFT = t6.KODESHIFT AND DATE('$tgl') <= DATE(t5.TGLSAMPAI) AND DATE('$tgl') >= DATE(t5.TGLMULAI) AND T6.NIK=$nik";
		$query = $this->db->query($sql);
		$rs = $query->result_array();
		//$this->firephp->info($query->result_array());
		$data = array();
		if($query->num_rows() > 0)
		{
			$data['JKURANG'] = intval($rs[0]['TOTALJAM']) - intval($norm);
			if($data['JKURANG'] >= 0)
			{
				$data['JAMDARI'] = $rs[0]['JAMDARI'];
				$data['JAMSAMPAI'] = $rs[0]['JAMSAMPAI'];
				return $data;
			}
			else
			{
				$data['JKURANG'] = 0;
				$data['JAMDARI'] = $rs[0]['JAMDARI'];
				$data['JAMSAMPAI'] = $rs[0]['JAMSAMPAI'];
				return $data;
			}
		}
		else
		{
			return 0;
		}
	}
	
	function JamBolosPerHari(){
		
	}
	
	function ExtraDay(){
		
	}
	
	function Terlambat(){
		$sql = "SELECT IF((TIME_FORMAT(TIMEDIFF(TIME('".$terlambat."'),'".$jkurang['JAMDARI']."'),'%H') <= 0),IF((TIME_FORMAT(TIMEDIFF(TIME('".$terlambat."'),'".$jkurang['JAMDARI']."'),'%i') <= 0),'T','Y'),'Y') as TERLAMBAT,
			IF((TIME_FORMAT(TIMEDIFF(TIME('".$jkurang['JAMSAMPAI']."'),TIME('".$plglbhawal."')),'%H') <= 0),IF((TIME_FORMAT(TIMEDIFF(TIME('".$jkurang['JAMSAMPAI']."'),TIME('".$plglbhawal."')),'%i') <= 0),'T','Y'),'Y') as PLGLBHAWAL;";
		$query = $this->db->query($sql);
	}
	
	function UpdatePresensi($tgl){
		$array = array('parameter' => 'jam_kerja');
		$TimeWork = $this->db->select('value')->get_where('init',$array)->row_array();
		
		//$sql = "SELECT BULAN FROM hitungpresensi WHERE BULAN = '$tgl' GROUP BY BULAN";
		//$query = $this->db->query($sql)->result_array();
		
		$sql = "SELECT NIK,TJMASUK,TJKELUAR FROM presensi GROUP BY NIK";
		$query = $this->db->query($sql)->result_array();
		
		foreach($query as $v)
		{
			$nik = $v['NIK'];
			//$terlambat = $v['TJMASUK'];
			//$plglbhawal = $v['TJKELUAR'];
			
			$jk = $this->JamKerjaPerHari($tgl,$nik);
			$jkurang = $this->JamKurangPerHari($jk['JAMKERJA'],$tgl,$nik);
			
			/*$ex = "SELECT IF((TIME_FORMAT(TIMEDIFF(TIME('".$terlambat."'),'".$jkurang['JAMDARI']."'),'%H') <= 0) AND (TIME_FORMAT(TIMEDIFF(TIME('".$terlambat."'),'".$jkurang['JAMDARI']."'),'%i') <= 0),'T','Y') as TERLAMBAT,
IF((TIME_FORMAT(TIMEDIFF(TIME('".$jkurang['JAMSAMPAI']."'),TIME('".$plglbhawal."')),'%H') <= 0) AND (TIME_FORMAT(TIMEDIFF(TIME('".$jkurang['JAMSAMPAI']."'),TIME('".$plglbhawal."')),'%i') <= 0),'T','Y') AS PLGLBHAWAL";
			
			$ex = "SELECT IF((TIME_FORMAT(TIMEDIFF(TIME('".$terlambat."'),'".$jkurang['JAMDARI']."'),'%H') <= 0),IF((TIME_FORMAT(TIMEDIFF(TIME('".$terlambat."'),'".$jkurang['JAMDARI']."'),'%i') <= 0),'T','Y'),'Y') as TERLAMBAT,
			IF((TIME_FORMAT(TIMEDIFF(TIME('".$jkurang['JAMSAMPAI']."'),TIME('".$plglbhawal."')),'%H') <= 0),IF((TIME_FORMAT(TIMEDIFF(TIME('".$jkurang['JAMSAMPAI']."'),TIME('".$plglbhawal."')),'%i') <= 0),'T','Y'),'Y') as PLGLBHAWAL;";
			$quex = $this->db->query($ex)->result_array();
			
			$terlambat = $quex[0]['TERLAMBAT'];
			$plglbhawal = $quex[0]['PLGLBHAWAL'];
			*/
			
			//$this->firephp->info($jk['JAMKERJA']." ".$tgl." ".$nik." ".$jkurang);
			
			$sql = "UPDATE hitungpresensi
			SET JENISABSEN=(IF(".$jk['JAMKERJA']." >= ".(intval($TimeWork["value"])*60).",'HD','AL')), JAMKERJA='".$jk['JAMKERJA']."', 
			HARIKERJA=(IF(".$jk['JAMKERJA']." >= ".(intval($TimeWork["value"])*60).",1,0)), 
			JAMLEMBUR='".$jk['JAMLEMBUR']."',
			JAMKURANG='".$jkurang['JKURANG']."',
			TERLAMBAT='".$terlambat."',
			PLGLBHAWAL='".$plglbhawal."'
			WHERE NIK=$nik AND TANGGAL='$tgl'";
			$query = $this->db->query($sql);
		}
		
	}
	
	function ProsesUpdate($bulangaji){
		$bln = $bulangaji . "01";
		$this->db->select('TGLMULAI,TGLSAMPAI');
		$sql = $this->db->get_where('periodegaji',array('BULAN' => $bulangaji))->result_array();
		
		$TMASUK = new DateTime($sql[0]['TGLMULAI']);
		$TSAMPAI = new DateTime($sql[0]['TGLSAMPAI']);
		$TM = intval($TMASUK->format('d'));
		$TS = intval($TSAMPAI->format('d'));
		
		$sql = "SELECT NIK FROM presensi GROUP BY NIK";
		$query = $this->db->query($sql)->result_array();
		
		foreach($query as $lsnik)
		{
			for($i=$TM;$i<=$TS;$i++)
			{
				$tgl = new DateTime($TMASUK->format('Y-m')."-".$i);
				//echo $tgl->format('Y-m-d')." ".$lsnik['NIK']."<br />";
				//$jk = $this->JamKerja($tgl->format('Y-m-d'),$lsnik['NIK']);
				//var_dump($jk);
				//echo $tgl->format('Y-m-d')." ".$lsnik['NIK']."<br /><br />";
				$this->UpdatePresensi($tgl->format('Y-m-d'),$lsnik['NIK']);
			}
			//echo $lsnik['NIK']."<br />";
		}	
	}
	
	function LoopUpdate($bulangaji,$tglmulai,$tglsampai){		
		
		$sql = "SELECT BULAN FROM hitungpresensi WHERE BULAN = '$bulangaji' GROUP BY BULAN";
		$query = $this->db->query($sql)->result_array();
		
		if(sizeof($query) > 0)
		{
			//$this->ProsesUpdate($bulangaji);
			$this->ProcessUpdate($tglmulai,$tglsampai);			
		}
		else
		{
			$this->InitRecord($bulangaji);
		}
		
		$total  = $this->db->get('hitungpresensi')->num_rows();
		$last   = $this->db->select('NIK, BULAN,TANGGAL,JENISABSEN,HARIKERJA,JAMKERJA,JAMLEMBUR,JAMKURANG')->order_by('NIK', 'ASC')->get('hitungpresensi')->row();
		$json	= array(
			'success'   => TRUE,
			'message'   => "Data berhasil diproses",
			'total'     => $total,
			'data'      => $last
		);
		
		return $json;
	}
	
	function JamKerja($bulangaji){
		$array = array('parameter' => 'jam_kerja');
		$TimeWork = $this->db->select('value')->get_where('init',$array)->row_array();
		$bln = $bulangaji . "01";
		// Checking data
		//$rs = $this->db->query("SELECT BULAN from hitungpresensi WHERE BULAN = (SELECT BULAN from periodegaji)");
		//var_dump($rs);
		/*
		
		* ------------------ Proses Import Presensi dari Absensi
		SELECT trans_pengenal,trans_tgl,trans_jam,MAX(trans_jam)as trans_keluar,trans_status, TIMESTAMP(MIN(trans_tgl),MIN(trans_jam)) as MASUK, TIMESTAMP(MAX(trans_tgl),MAX(trans_jam)) as KELUAR,trans_log
		FROM mybase.absensi 
		GROUP BY trans_pengenal,trans_tgl;
		
		
		* ------------------ Proses Import Presensi Absensi Revisi 05-07-2013 --------------------------
		select t.trans_pengenal,t.trans_tgl,t.trans_jam,MAX(t.trans_jam)as trans_keluar,t.trans_status, 
		TIMESTAMP(MIN(t.trans_tgl),MIN(t.trans_jam)) as MASUK, 
		TIMESTAMP(MAX(t.trans_tgl),MAX(t.trans_jam)) as KELUAR,count(t.trans_tgl) as jml
		from (
		SELECT DISTINCT trans_pengenal,trans_tgl,trans_jam,trans_status,trans_log
			FROM mybase.absensi ) as t
		group by t.trans_pengenal, t.trans_tgl;
		
		* ------------------ Proses Import Presensi Absensi Revisi 10-07-2013 --------------------------
		INSERT INTO dbympi.presensi
		(NIK,TJMASUK,TJKELUAR,ASALDATA,USERNAME)
		select t.trans_pengenal AS NIK,
		TIMESTAMP(MIN(t.trans_tgl),MIN(t.trans_jam)) as TJMASUK, 
		TIMESTAMP(MAX(t.trans_tgl),MAX(t.trans_jam)) as TJKELUAR,
		'D' AS ASALDATA,
		'Super Admin' AS USERNAME
		from (
		SELECT DISTINCT trans_pengenal,trans_tgl,trans_jam,trans_status,trans_log
			FROM mybase.absensi ) as t
		WHERE t.trans_tgl >= DATE('2012-10-01') AND t.trans_tgl <= DATE('2012-10-31') AND t.trans_pengenal=00010429
		group by t.trans_pengenal, t.trans_tgl;
		
		
		select t.trans_pengenal,t.trans_tgl,t.trans_jam,MAX(t.trans_jam)as trans_keluar,t.trans_status, 
		TIMESTAMP(MIN(t.trans_tgl),MIN(t.trans_jam)) as MASUK, 
		TIMESTAMP(MAX(t.trans_tgl),MAX(t.trans_jam)) as KELUAR,count(t.trans_tgl) as jml
		from (
		SELECT DISTINCT trans_pengenal,trans_tgl,trans_jam,trans_status,trans_log
			FROM mybase.absensi ) as t
		WHERE t.trans_tgl >= DATE('2012-10-01') AND t.trans_tgl <= DATE('2012-10-31') AND t.trans_pengenal=00010429
		group by t.trans_pengenal, t.trans_tgl;
		
		
		* ------------------------ Proses Import Presensi Absensi Revisi 11-07-2013
		INSERT INTO dbympi.presensi
		(NIK,TJMASUK,TJKELUAR,ASALDATA,USERNAME)
		SELECT t1.NIK AS NIK,
		t1.MASUK AS TJMASUK,
		t1.KELUAR AS TJKELUAR,
		'D' AS ASALDATA,
		'Super Admin' AS USERNAME
		FROM (
			SELECT k.NIK, j.trans_tgl, j.trans_jam, j.trans_keluar, j.trans_status, j.MASUK, j.KELUAR, j.jml as JRECORD
			FROM dbympi.karyawan k
			JOIN (
			select t.trans_pengenal,t.trans_tgl,t.trans_jam,MAX(t.trans_jam)as trans_keluar,t.trans_status, 
			TIMESTAMP(MIN(t.trans_tgl),MIN(t.trans_jam)) as MASUK, 
			TIMESTAMP(MAX(t.trans_tgl),MAX(t.trans_jam)) as KELUAR,count(t.trans_tgl) as jml
			from (
			SELECT DISTINCT trans_pengenal,trans_tgl,trans_jam,trans_status,trans_log
				FROM mybase.absensi ) as t
			WHERE t.trans_tgl >= DATE('2012-10-01') AND t.trans_tgl <= DATE('2012-10-31')
			group by t.trans_pengenal, t.trans_tgl) as j
			ON k.NIK=j.trans_pengenal) as t1
		WHERE t1.trans_tgl >= DATE('2012-10-01') AND t1.trans_tgl <= DATE('2012-10-31')


		* -----------------------------------------------------

		*
		* ----------------- 04-07-2013 Proses 1 Inisialisasi -----------------
		

		* ----------------------------------
		*
		* ----------------- 03-07-2013 Proses 2 Update untuk JamKerja -----------------
		UPDATE hitungpresensi t1
		JOIN (
		SELECT t2.nik, DATE(t2.tjmasuk) as TANGGAL, t2.TJMASUK, MAX(t2.TJKELUAR) AS TJKELUAR, SUM(TIMESTAMPDIFF(MINUTE,t2.TJMASUK,t2.TJKELUAR)) AS JAMKERJA
		FROM presensi t2
		WHERE t2.TJMASUK >= DATE('2012-08-01') and t2.TJKELUAR <= DATE('2012-08-31')
		GROUP BY t2.NIK, DATE(t2.TJMASUK)) as t3
		ON t1.NIK=t3.nik AND t1.TANGGAL=t3.TANGGAL
		SET t1.JAMKERJA = t3.JAMKERJA;
		
		* ---------------------- 04-07-2013 Revisi Proses 2 Update Untuk JamKerja Bersih setelah dipotong MakanSiang / MakanMalam
		UPDATE hitungpresensi t1
		JOIN (
			SELECT t2.nik, DATE(t2.tjmasuk) as TANGGAL, MIN(t2.TJMASUK) AS TJMASUK, MAX(t2.TJKELUAR) AS TJKELUAR, SUM(TIMESTAMPDIFF(MINUTE,t2.TJMASUK,t2.TJKELUAR)) AS JAMKERJA,
			IF((
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'))AND(TIMESTAMP(MAX(t2.TJKELUAR))< TIMESTAMP(DATE(t2.TJMASUK),'18:00:00')),60,0)))=0,
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'18:30:00'),30,0)),
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),60,0))) AS POTONGMAKAN,
			(SUM(TIMESTAMPDIFF(MINUTE,t2.TJMASUK,t2.TJKELUAR)) - (IF((
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'))AND(TIME(t2.TJKELUAR)< TIMESTAMP(DATE(t2.TJMASUK),'18:00:00')),60,0)))=0,
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'18:30:00'),30,0)),
			IF(TIMESTAMP(MAX(t2.TJKELUAR)) < TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t2.TJKELUAR)) > TIMESTAMP(DATE(t2.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t2.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t2.TJKELUAR))> TIMESTAMP(DATE(t2.TJMASUK),'13:00:00'),60,0))))) AS JAMBERSIH
			FROM presensi t2
			WHERE t2.TJMASUK >= DATE('2012-08-01') and t2.TJKELUAR <= DATE('2012-08-31')
			GROUP BY t2.NIK, DATE(t2.TJMASUK)) AS t3
		ON t1.NIK=t3.nik AND t1.TANGGAL=t3.TANGGAL
		SET t1.JAMKERJA = t3.JAMBERSIH;
		* ----------------------------------
		*
		*
		*
		*
		*
		* ----------------- 04-07-2013 Proses 3 Update untuk JAMKERJA, JAMLEMBUR, JENISLEMBUR, EXTRADAY -----------------
		UPDATE hitungpresensi t5
		JOIN (
			SELECT DATE(t1.TJMASUK) as TANGGAL, t1.NIK, t1.TJMASUK, MAX(t1.TJKELUAR) as JAMKELUAR,t4.TJMASUK as TJLEMBUR, SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, 
			SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as LEMBURKOTOR,
			IF((
			IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF((TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'))AND(TIME(MAX(t1.TJKELUAR))< TIME('18:00:00')),60,0)))=0,
			IF(TIME(MAX(t1.TJKELUAR)) < TIME('18:30:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('18:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('18:30:00'),30,0)),
			IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'),60,0))) AS POTONGMAKAN,
			(SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) - (IF((
			IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF((TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'))AND(TIME(t1.TJKELUAR)< TIME('18:00:00')),60,0)))=0,
			IF(TIME(MAX(t1.TJKELUAR)) < TIME('18:30:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('18:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('18:30:00'),30,0)),
			IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'),60,0))))) AS JAMLEMBUR,
			t4.JENISLEMBUR,
			IF(t4.JENISLEMBUR = 'B',0,1) AS EXTRADAY,
			SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
			FROM presensi t1
				JOIN (
				SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK, t3.JENISLEMBUR
				FROM splembur t2
				RIGHT JOIN rencanalembur t3
				ON t2.NOLEMBUR = t3.NOLEMBUR AND DATE(t3.TJMASUK)>=DATE('2012-08-01') AND DATE(t3.TJMASUK)<=DATE('2012-08-31') ) as t4
			ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
			GROUP BY t1.NIK,DATE(t1.TJMASUK)) as t6
			ON t5.NIK=t6.NIK AND t5.TANGGAL=t6.TANGGAL
		SET
			t5.JAMKERJA=t6.JAMKERJA,
			t5.JAMLEMBUR=t6.JAMLEMBUR,
			t5.JENISLEMBUR=t6.JENISLEMBUR,
			t5.EXTRADAY=t6.EXTRADAY;

		* ----------------------------------
		*
		* ----------------- 05-07-2013 Proses 4 Update untuk JENISABSEN, HARIKERJA, JAMKURANG, TERLAMBAT, PLGLBHAWAL -----------------
		UPDATE hitungpresensi t9
		JOIN (
		SELECT t8.KODESHIFT,t8.NAMASHIFT,t8.SHIFTKE,t8.JAMDARI,t8.JAMSAMPAI,t8.TOTALJAM,t7.NIK,DATE(MIN(t7.TJMASUK))AS TANGGAL,t8.JENISHARI,MIN(t7.TJMASUK)AS JAMMASUK,MAX(t7.TJKELUAR)AS JAMKELUAR,
		SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) AS JAMKERJA,
		IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIMESTAMP(MAX(t7.TJKELUAR))< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))))) AS JAMBERSIH,
		IF(TIME(MIN(t7.TJMASUK)) > TIME(t8.JAMDARI),'Y','T') as TERLAMBAT,
		IF(TIME(MAX(t7.TJKELUAR)) < TIME(t8.JAMSAMPAI),'Y','T') as PLGLBHAWAL
		FROM presensi t7
		JOIN (
			SELECT t5.VALIDTO, t6.KODESHIFT, t6.NIK, t5.NAMASHIFT, t5.SHIFTKE,t5.JENISHARI, t5.JAMDARI, t5.JAMSAMPAI, ((HOUR(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))*60) + MINUTE(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))) as TOTALJAM, t5.TGLMULAI, t5.TGLSAMPAI
			FROM karyawanshift t6
			JOIN (
				SELECT t4.VALIDTO, t4.KODESHIFT, t1.NAMASHIFT, t1.SHIFTKE, t1.JENISHARI, t1.JAMDARI, t1.JAMSAMPAI, t4.TGLMULAI,t4.TGLSAMPAI
				FROM shiftjamkerja t1
				JOIN (
				SELECT t3.KODESHIFT, t2.NAMASHIFT, t3.SHIFTKE, t2.VALIDTO, t3.TGLMULAI, t3.TGLSAMPAI
				FROM shift t2
				RIGHT JOIN pembagianshift t3
				ON t2.NAMASHIFT=t3.NAMASHIFT) as t4
				ON t1.NAMASHIFT=t4.namashift AND t1.SHIFTKE=t4.SHIFTKE) as t5
			ON t5.KODESHIFT = t6.KODESHIFT ) as t8
		ON t7.NIK=t8.NIK AND DATE(t7.TJMASUK) <= DATE(t8.TGLSAMPAI) AND DATE(t7.TJMASUK) >= DATE(t8.TGLMULAI) AND (t8.JENISHARI = (IF(DAYNAME(DATE(t7.TJMASUK)) = 'Friday','J','N')))
		GROUP BY t7.NIK,DATE(t7.TJMASUK), t8.JENISHARI) AS t10
		ON t9.NIK=t10.NIK AND t9.TANGGAL=t10.TANGGAL AND DATE(t10.TANGGAL)>=DATE('2012-08-01') AND DATE(t10.TANGGAL)<=DATE('2012-08-31')
		SET
			t9.JENISABSEN=IF((IF(t10.JAMBERSIH >= t10.TOTALJAM,1,0)) = 1,'HD','AL'),
			t9.HARIKERJA=IF(t10.JAMBERSIH >= t10.TOTALJAM,1,0),
			t9.JAMKERJA=t10.JAMBERSIH,
			t9.TERLAMBAT=t10.TERLAMBAT,
			t9.PLGLBHAWAL=t10.PLGLBHAWAL;
			
		* -------- Revisi Terbaru ------
		UPDATE hitungpresensi t9
		JOIN (
		SELECT t8.KODESHIFT,t8.NAMASHIFT,t8.SHIFTKE,t8.JAMDARI,t8.JAMSAMPAI,t8.TOTALJAM,t7.NIK,DATE(MIN(t7.TJMASUK))AS TANGGAL,t8.JENISHARI,MIN(t7.TJMASUK)AS JAMMASUK,MAX(t7.TJKELUAR)AS JAMKELUAR,
		SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) AS JAMKERJA,
		IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIMESTAMP(MAX(t7.TJKELUAR))< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))))) AS JAMBERSIH,
		IF((t8.TOTALJAM-(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0)))))) >=0,(t8.TOTALJAM-(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0)))))),0) AS JAMKURANG,
		IF(TIME(MIN(t7.TJMASUK)) > TIME(t8.JAMDARI),'Y','T') as TERLAMBAT,
		IF(TIME(MAX(t7.TJKELUAR)) < TIME(t8.JAMSAMPAI),'Y','T') as PLGLBHAWAL
		FROM presensi t7
		JOIN (
			SELECT t5.VALIDTO, t6.KODESHIFT, t6.NIK, t5.NAMASHIFT, t5.SHIFTKE,t5.JENISHARI, t5.JAMDARI, t5.JAMSAMPAI, ((HOUR(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))*60) + MINUTE(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))) as TOTALJAM, t5.TGLMULAI, t5.TGLSAMPAI
			FROM karyawanshift t6
			JOIN (
				SELECT t4.VALIDTO, t4.KODESHIFT, t1.NAMASHIFT, t1.SHIFTKE, t1.JENISHARI, t1.JAMDARI, t1.JAMSAMPAI, t4.TGLMULAI,t4.TGLSAMPAI
				FROM shiftjamkerja t1
				JOIN (
				SELECT t3.KODESHIFT, t2.NAMASHIFT, t3.SHIFTKE, t2.VALIDTO, t3.TGLMULAI, t3.TGLSAMPAI
				FROM shift t2
				RIGHT JOIN pembagianshift t3
				ON t2.NAMASHIFT=t3.NAMASHIFT) as t4
				ON t1.NAMASHIFT=t4.namashift AND t1.SHIFTKE=t4.SHIFTKE) as t5
			ON t5.KODESHIFT = t6.KODESHIFT ) as t8
		ON t7.NIK=t8.NIK AND DATE(t7.TJMASUK) <= DATE(t8.TGLSAMPAI) AND DATE(t7.TJMASUK) >= DATE(t8.TGLMULAI) AND (t8.JENISHARI = (IF(DAYNAME(DATE(t7.TJMASUK)) = 'Friday','J','N')))
		GROUP BY t7.NIK,DATE(t7.TJMASUK), t8.JENISHARI) AS t10
		ON t9.NIK=t10.NIK AND t9.TANGGAL=t10.TANGGAL AND DATE(t10.TANGGAL)>=DATE('2012-08-01') AND DATE(t10.TANGGAL)<=DATE('2012-08-31')
		SET
			t9.JENISABSEN=IF((IF(t10.JAMBERSIH >= t10.TOTALJAM,1,0)) = 1,'HD','AL'),
			t9.HARIKERJA=IF(t10.JAMBERSIH >= t10.TOTALJAM,1,0),
			t9.JAMKERJA=t10.JAMBERSIH,
			t9.JAMKURANG=t10.JAMKURANG,
			t9.TERLAMBAT=t10.TERLAMBAT,
			t9.PLGLBHAWAL=t10.PLGLBHAWAL;
		* --------------
		
		
		
		SELECT t8.KODESHIFT,t8.NAMASHIFT,t8.SHIFTKE,t8.JAMDARI,t8.JAMSAMPAI,t8.TOTALJAM,t7.NIK,DATE(MIN(t7.TJMASUK))AS TANGGAL,t8.JENISHARI,MIN(t7.TJMASUK)AS JAMMASUK,MAX(t7.TJKELUAR)AS JAMKELUAR,
		SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) AS JAMKERJA,
		IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIMESTAMP(MAX(t7.TJKELUAR))< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))))) AS JAMBERSIH,
		IF((MIN(t7.TJMASUK)) > TIMESTAMP(DATE(t7.TJMASUK),t8.JAMDARI),'Y','T') as TERLAMBAT,
		IF((MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),t8.JAMSAMPAI),'Y','T') as PLGLBHAWAL
		FROM presensi t7
		JOIN (
			SELECT t5.VALIDTO, t6.KODESHIFT, t6.NIK, t5.NAMASHIFT, t5.SHIFTKE,t5.JENISHARI, t5.JAMDARI, t5.JAMSAMPAI, ((HOUR(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))*60) + MINUTE(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))) as TOTALJAM, t5.TGLMULAI, t5.TGLSAMPAI
			FROM karyawanshift t6
			JOIN (
				SELECT t4.VALIDTO, t4.KODESHIFT, t1.NAMASHIFT, t1.SHIFTKE, t1.JENISHARI, t1.JAMDARI, t1.JAMSAMPAI, t4.TGLMULAI,t4.TGLSAMPAI
				FROM shiftjamkerja t1
				JOIN (
				SELECT t3.KODESHIFT, t2.NAMASHIFT, t3.SHIFTKE, t2.VALIDTO, t3.TGLMULAI, t3.TGLSAMPAI
				FROM shift t2
				RIGHT JOIN pembagianshift t3
				ON t2.NAMASHIFT=t3.NAMASHIFT) as t4
				ON t1.NAMASHIFT=t4.namashift AND t1.SHIFTKE=t4.SHIFTKE) as t5
			ON t5.KODESHIFT = t6.KODESHIFT ) as t8
		ON t7.NIK=t8.NIK AND DATE(t7.TJMASUK) <= DATE(t8.TGLSAMPAI) AND DATE(t7.TJMASUK) >= DATE(t8.TGLMULAI) AND (t8.JENISHARI = (IF(DAYNAME(DATE(t7.TJMASUK)) = 'Friday','J','N')))
		GROUP BY t7.NIK,DATE(t7.TJMASUK), t8.JENISHARI
		
		* -------------- Revisi 05-07-2013 tambahan JamKurang ------------------------
		SELECT t8.KODESHIFT,t8.NAMASHIFT,t8.SHIFTKE,t8.JAMDARI,t8.JAMSAMPAI,t8.TOTALJAM,t7.NIK,DATE(MIN(t7.TJMASUK))AS TANGGAL,t8.JENISHARI,MIN(t7.TJMASUK)AS JAMMASUK,MAX(t7.TJKELUAR)AS JAMKELUAR,
		SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) AS JAMKERJA,
		IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIMESTAMP(MAX(t7.TJKELUAR))< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))))) AS JAMBERSIH,
		IF((t8.TOTALJAM-(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0)))))) >=0,(t8.TOTALJAM-(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0)))))),0) AS JAMKURANG,
		IF(TIME(MIN(t7.TJMASUK)) > TIME(t8.JAMDARI),'Y','T') as TERLAMBAT,
		IF(TIME(MAX(t7.TJKELUAR)) < TIME(t8.JAMSAMPAI),'Y','T') as PLGLBHAWAL
		FROM presensi t7
		JOIN (
			SELECT t5.VALIDTO, t6.KODESHIFT, t6.NIK, t5.NAMASHIFT, t5.SHIFTKE,t5.JENISHARI, t5.JAMDARI, t5.JAMSAMPAI, ((HOUR(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))*60) + MINUTE(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))) as TOTALJAM, t5.TGLMULAI, t5.TGLSAMPAI
			FROM karyawanshift t6
			JOIN (
				SELECT t4.VALIDTO, t4.KODESHIFT, t1.NAMASHIFT, t1.SHIFTKE, t1.JENISHARI, t1.JAMDARI, t1.JAMSAMPAI, t4.TGLMULAI,t4.TGLSAMPAI
				FROM shiftjamkerja t1
				JOIN (
				SELECT t3.KODESHIFT, t2.NAMASHIFT, t3.SHIFTKE, t2.VALIDTO, t3.TGLMULAI, t3.TGLSAMPAI
				FROM shift t2
				RIGHT JOIN pembagianshift t3
				ON t2.NAMASHIFT=t3.NAMASHIFT) as t4
				ON t1.NAMASHIFT=t4.namashift AND t1.SHIFTKE=t4.SHIFTKE) as t5
			ON t5.KODESHIFT = t6.KODESHIFT ) as t8
		ON t7.NIK=t8.NIK AND DATE(t7.TJMASUK) <= DATE(t8.TGLSAMPAI) AND DATE(t7.TJMASUK) >= DATE(t8.TGLMULAI) AND (t8.JENISHARI = (IF(DAYNAME(DATE(t7.TJMASUK)) = 'Friday','J','N')))
		GROUP BY t7.NIK,DATE(t7.TJMASUK), t8.JENISHARI
		* ----------------------------------
		
		* -------------------------- 03-07-2013 Proses List Lembur dengan parameter kondisi Pemotongan Jam Makan Siang dan Makan Malam FIX --------------
		SELECT DATE(t1.TJMASUK) as TANGGAL, t1.NIK, t1.TJMASUK, MAX(t1.TJKELUAR) as JAMKELUAR,t4.TJMASUK as TJLEMBUR, SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, 
		SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as LEMBURKOTOR,
		IF((
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF((TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'))AND(TIME(MAX(t1.TJKELUAR))< TIME('18:00:00')),60,0)))=0,
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('18:30:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('18:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('18:30:00'),30,0)),
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) -(IF((
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF((TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'))AND(TIME('2012-08-08 23:06:00')< TIME('18:00:00')),60,0)))=0,
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('18:30:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('18:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('18:30:00'),30,0)),
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'),60,0))))) AS JAMLEMBUR,
		SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR AND DATE(t3.TJMASUK)>=DATE('2012-08-01') AND DATE(t3.TJMASUK)<=DATE('2012-08-31') ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
		GROUP BY t1.NIK,DATE(t1.TJMASUK);
		* ---------------------------------------------------------------------------
		
		* ----------------------- Ini adalah query ujicoba berdasar Shiftjamkerja potong JAMLEMBUR saat MAKAN SIANG dan MAKAN MALAM ---------------------------------
		
		
		* ---------------------------- 04-07-13 UJI POTONG MAKAN SIANG MALAM ------------------------
		SELECT t8.KODESHIFT,t8.NAMASHIFT,t8.SHIFTKE,t8.JAMDARI,t8.JAMSAMPAI,t8.TOTALJAM,t7.NIK,t8.JENISHARI,MIN(t7.TJMASUK)AS JAMMASUK,MAX(t7.TJKELUAR)AS JAMKELUAR,
		SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) AS JAMKERJA,
		IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIMESTAMP(MAX(t7.TJKELUAR))< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t7.TJMASUK,t7.TJKELUAR)) - (IF((
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF((TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'))AND(TIME(t7.TJKELUAR)< TIMESTAMP(DATE(t7.TJMASUK),'18:00:00')),60,0)))=0,
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'18:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'18:30:00'),30,0)),
		IF(TIMESTAMP(MAX(t7.TJKELUAR)) < TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),IF(TIMESTAMP(MAX(t7.TJKELUAR)) > TIMESTAMP(DATE(t7.TJMASUK),'12:00:00'),TIME_FORMAT(TIMESTAMP(MAX(t7.TJKELUAR)),'%i'),0),IF(TIMESTAMP(MAX(t7.TJKELUAR))> TIMESTAMP(DATE(t7.TJMASUK),'13:00:00'),60,0))))) AS JAMBERSIH,
		IF(TIME(MIN(t7.TJMASUK)) > TIME(t8.JAMDARI),'Y','T') as TERLAMBAT,
		IF(TIME(MAX(t7.TJKELUAR)) < TIME(t8.JAMSAMPAI),'Y','T') as PLGLBHAWAL
		FROM presensi t7
		JOIN (
			SELECT t5.VALIDTO, t6.KODESHIFT, t6.NIK, t5.NAMASHIFT, t5.SHIFTKE,t5.JENISHARI, t5.JAMDARI, t5.JAMSAMPAI, ((HOUR(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))*60) + MINUTE(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))) as TOTALJAM, t5.TGLMULAI, t5.TGLSAMPAI
			FROM karyawanshift t6
			JOIN (
				SELECT t4.VALIDTO, t4.KODESHIFT, t1.NAMASHIFT, t1.SHIFTKE, t1.JENISHARI, t1.JAMDARI, t1.JAMSAMPAI, t4.TGLMULAI,t4.TGLSAMPAI
				FROM shiftjamkerja t1
				JOIN (
				SELECT t3.KODESHIFT, t2.NAMASHIFT, t3.SHIFTKE, t2.VALIDTO, t3.TGLMULAI, t3.TGLSAMPAI
				FROM shift t2
				RIGHT JOIN pembagianshift t3
				ON t2.NAMASHIFT=t3.NAMASHIFT) as t4
				ON t1.NAMASHIFT=t4.namashift AND t1.SHIFTKE=t4.SHIFTKE) as t5
			ON t5.KODESHIFT = t6.KODESHIFT ) as t8
		ON t7.NIK=t8.NIK AND DATE(t7.TJMASUK) <= DATE(t8.TGLSAMPAI) AND DATE(t7.TJMASUK) >= DATE(t8.TGLMULAI) AND (t8.JENISHARI = (IF(DAYNAME(DATE(t7.TJMASUK)) = 'Friday','J','N')))
		GROUP BY t7.NIK,DATE(t7.TJMASUK), t8.JENISHARI;
		* ---------------------------------------
		
		
		* ----------- ini adalah proses hitung presensi bila ada 2 record dalam 1 hari -------------
		SELECT DATE_FORMAT(t1.TJMASUK,'%Y-%m-%d') as TANGGAL, t1.NIK, t1.TJMASUK, t1.TJKELUAR,t4.TJMASUK as TJLEMBUR, sum(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as JAMLEMBUR, SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
		GROUP BY t1.NIK
		* --------------------------------------------------------
		
		* --------------------------- ini adalah query untuk penentuan jenis lembur pada kalenderlibur --------------------
		SELECT t7.TANGGAL, t7.JENISLIBUR, t7.AGAMA as LIBURAGAMA, t8.NIK, t8.AGAMA, t8.TJMASUK, t8.TJKELUAR, t8.TJLEMBUR, t8.JAMKERJA, t8.JAMLEMBUR, t8.TOTAL
		FROM kalenderlibur t7
		JOIN (
		SELECT t6.TANGGAL, t5.NIK, t5.AGAMA, t6.TJMASUK, t6.TJKELUAR,t6.TJLEMBUR, t6.JAMKERJA, t6.JAMLEMBUR, t6.TOTAL
		FROM karyawan t5
		JOIN (
		SELECT DATE_FORMAT(t1.TJMASUK,'%Y-%m-%d') as TANGGAL, t1.NIK, t1.TJMASUK, t1.TJKELUAR,t4.TJMASUK as TJLEMBUR, sum(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as JAMLEMBUR, SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
		GROUP BY t1.NIK) as t6
		ON t6.NIK=t5.NIK ) as t8
		ON t8.TANGGAL=t7.TANGGAL;
		
		
		SELECT t7.TANGGAL, t7.JENISLIBUR, t7.AGAMA as LIBURAGAMA, t8.NIK, t8.AGAMA, t8.TJMASUK, t8.TJKELUAR, t8.TJLEMBUR, t8.JAMKERJA, t8.JAMLEMBUR,t7.jenislibur as JENISLEMBUR, 1 as EXTRADAY, IF(TIME(t8.tjkeluar) >= TIME('18:00:00'),'Y','T') as MALAM, IF(TIME(t8.tjkeluar) >= TIME('13:00:00'),'Y','T') as SIANG, t8.TOTAL
		FROM kalenderlibur t7
		JOIN (
		SELECT t6.TANGGAL, t5.NIK, t5.AGAMA, t6.TJMASUK, t6.TJKELUAR,t6.TJLEMBUR, t6.JAMKERJA, t6.JAMLEMBUR, t6.TOTAL
		FROM karyawan t5
		JOIN (
		SELECT DATE_FORMAT(t1.TJMASUK,'%Y-%m-%d') as TANGGAL, t1.NIK, t1.TJMASUK, t1.TJKELUAR,t4.TJMASUK as TJLEMBUR, sum(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as JAMLEMBUR, SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
		GROUP BY t1.NIK) as t6
		ON t6.NIK=t5.NIK ) as t8
		ON t8.TANGGAL=t7.TANGGAL;
		* ------------------------------------------------------------------
		
		
		
		SELECT t7.TANGGAL, t7.JENISLIBUR, t7.AGAMA as LIBURAGAMA, t8.NIK, t8.AGAMA, t8.TJMASUK, t8.TJKELUAR, t8.TJLEMBUR, t8.JAMKERJA, t8.JAMLEMBUR,
		IF(TIME(t8.TJKELUAR) < TIME('13:00:00'),IF(TIME(t8.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('13:00:00'),60,0)) as POTONGMSIANG,
		IF(TIME(t8.TJKELUAR) < TIME('18:30:00'),IF(TIME(t8.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('18:30:00'),60,0)) AS POTONGMMALAM,
		IF((
		IF(TIME(t8.TJKELUAR) < TIME('13:00:00'),IF(TIME(t8.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('13:00:00'),60,0)))=0,
		IF(TIME(t8.TJKELUAR) < TIME('18:30:00'),IF(TIME(t8.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('18:30:00'),60,0)),
		IF(TIME(t8.TJKELUAR) < TIME('13:00:00'),IF(TIME(t8.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('13:00:00'),60,0))) AS POTONGMAKAN,
		(t8.JAMLEMBUR -(IF((
		IF(TIME(t8.TJKELUAR) < TIME('13:00:00'),IF(TIME(t8.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('13:00:00'),60,0)))=0,
		IF(TIME(t8.TJKELUAR) < TIME('18:30:00'),IF(TIME(t8.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('18:30:00'),60,0)),
		IF(TIME(t8.TJKELUAR) < TIME('13:00:00'),IF(TIME(t8.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('13:00:00'),60,0))))) AS LEMBURBERSIH
		,t7.jenislibur as JENISLEMBUR, 1 as EXTRADAY, t8.TOTAL
		FROM kalenderlibur t7
		JOIN (
		SELECT t6.TANGGAL, t5.NIK, t5.AGAMA, t6.TJMASUK, t6.TJKELUAR,t6.TJLEMBUR, t6.JAMKERJA, t6.JAMLEMBUR, t6.TOTAL
		FROM karyawan t5
		JOIN (
		SELECT DATE_FORMAT(t1.TJMASUK,'%Y-%m-%d') as TANGGAL, t1.NIK, t1.TJMASUK, t1.TJKELUAR,t4.TJMASUK as TJLEMBUR, sum(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as JAMLEMBUR, SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
		GROUP BY t1.NIK) as t6
		ON t6.NIK=t5.NIK ) as t8
		ON t8.TANGGAL=t7.TANGGAL;


		SELECT DATE(t1.TJMASUK) as TANGGAL, t1.NIK, t1.TJMASUK, MAX(t1.TJKELUAR) as JAMKELUAR,t4.TJMASUK as TJLEMBUR, SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, 
		SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as LEMBURKOTOR,
		IF((
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF((TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'))AND(TIME(MAX(t1.TJKELUAR))< TIME('18:00:00')),60,0)))=0,
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('18:30:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('18:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('18:30:00'),30,0)),
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) - (IF((
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF((TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'))AND(TIME(t1.TJKELUAR)< TIME('18:00:00')),60,0)))=0,
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('18:30:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('18:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('18:30:00'),30,0)),
		IF(TIME(MAX(t1.TJKELUAR)) < TIME('13:00:00'),IF(TIME(MAX(t1.TJKELUAR)) > TIME('12:00:00'),TIME_FORMAT(TIME(MAX(t1.TJKELUAR)),'%i'),0),IF(TIME(MAX(t1.TJKELUAR))> TIME('13:00:00'),60,0))))) AS JAMLEMBUR,
		SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
			JOIN (
			SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK, t3.JENISLEMBUR
			FROM splembur t2
			RIGHT JOIN rencanalembur t3
			ON t2.NOLEMBUR = t3.NOLEMBUR AND DATE(t3.TJMASUK)>=DATE('2012-08-01') AND DATE(t3.TJMASUK)<=DATE('2012-08-31') ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
		GROUP BY t1.NIK,DATE(t1.TJMASUK);




		SELECT IF(TIME('2012-08-08 11:39:00') < TIME('13:00:00'),'ya','tdk') as JAM, IF(TIME('2012-08-08 11:39:00') > TIME('12:00:00'),TIME_FORMAT(TIME('2012-08-08 11:39:00'),'%i'),0) as MENIT, IF(TIME('2012-08-08 11:39:00')> TIME('13:00:00'),60,0) as LEBIH;
		SELECT IF(TIME('2012-08-08 12:39:00') < TIME('13:00:00'),'ya','tdk') as JAM, IF(TIME('2012-08-08 12:39:00') > TIME('12:00:00'),TIME_FORMAT(TIME('2012-08-08 12:39:00'),'%i'),0) as MENIT, IF(TIME('2012-08-08 12:39:00')> TIME('13:00:00'),60,0) as LEBIH;
		SELECT IF(TIME('2012-08-08 13:39:00') < TIME('13:00:00'),'ya','tdk') as JAM, IF(TIME('2012-08-08 13:39:00') > TIME('12:00:00'),TIME_FORMAT(TIME('2012-08-08 13:39:00'),'%i'),0) as MENIT, IF(TIME('2012-08-08 13:39:00')> TIME('13:00:00'),60,0) as LEBIH;

		SELECT IF(TIME('2012-08-08 12:39:00') < TIME('13:00:00'),IF(TIME('2012-08-08 12:39:00') > TIME('12:00:00'),TIME_FORMAT(TIME('2012-08-08 12:39:00'),'%i'),0),IF(TIME('2012-08-08 12:39:00')> TIME('13:00:00'),60,0)) as POTONGMAKANSIANG;

		SELECT IF(TIME('2012-08-08 12:39:00') < TIME('19:00:00'),IF(TIME('2012-08-08 12:39:00') > TIME('18:00:00'),TIME_FORMAT(TIME('2012-08-08 12:39:00'),'%i'),0),IF(TIME('2012-08-08 12:39:00')> TIME('19:00:00'),60,0)) as POTONGMAKANMALAM;
		SELECT IF(TIME('2012-08-08 18:42:00') < TIME('19:00:00'),IF(TIME('2012-08-08 18:42:00') > TIME('18:00:00'),TIME_FORMAT(TIME('2012-08-08 18:42:00'),'%i'),0),IF(TIME('2012-08-08 18:42:00')> TIME('19:00:00'),60,0)) as POTONGMAKANMALAM;
		SELECT IF(TIME('2012-08-08 19:42:00') < TIME('19:00:00'),IF(TIME('2012-08-08 19:42:00') > TIME('18:00:00'),TIME_FORMAT(TIME('2012-08-08 19:42:00'),'%i'),0),IF(TIME('2012-08-08 19:42:00')> TIME('19:00:00'),60,0)) as POTONGMAKANMALAM;

		SELECT IF((
		IF(TIME('2012-08-08 00:48:00') < TIME('13:00:00'),IF(TIME('2012-08-08 00:48:00') > TIME('12:00:00'),TIME_FORMAT(TIME('2012-08-08 00:48:00'),'%i'),0),IF((TIME('2012-08-08 00:48:00')> TIME('13:00:00'))AND(TIME(MAX('2012-08-08 00:48:00'))< TIME('18:00:00')),60,0)))=0,
		IF(TIME('2012-08-08 00:48:00') < TIME('18:30:00'),IF(TIME('2012-08-08 00:48:00') > TIME('18:00:00'),TIME_FORMAT(TIME('2012-08-08 00:48:00'),'%i'),0),IF(TIME('2012-08-08 00:48:00')> TIME('18:30:00'),30,0)),
		IF(TIME('2012-08-08 00:48:00') < TIME('13:00:00'),IF(TIME('2012-08-08 00:48:00') > TIME('12:00:00'),TIME_FORMAT(TIME('2012-08-08 00:48:00'),'%i'),0),IF(TIME('2012-08-08 00:48:00')> TIME('13:00:00'),60,0))) as BERSIH;
		
		
		
		SELECT t7.TANGGAL, t7.JENISLIBUR, t7.AGAMA as LIBURAGAMA, t8.NIK, t8.AGAMA, t8.TJMASUK, t8.TJKELUAR, t8.TJLEMBUR, t8.JAMKERJA, t8.JAMLEMBUR,
		IF(TIME(t8.TJKELUAR) < TIME('13:00:00'),IF(TIME(t8.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('13:00:00'),60,0)) as POTONGMSIANG,
		IF(TIME(t8.TJKELUAR) < TIME('18:30:00'),IF(TIME(t8.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('18:30:00'),60,0)) AS POTONGMMALAM,
		IF((
		IF(TIME(t8.TJKELUAR) < TIME('13:00:00'),IF(TIME(t8.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('13:00:00'),60,0)))=0,
		IF(TIME(t8.TJKELUAR) < TIME('18:30:00'),IF(TIME(t8.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('18:30:00'),60,0)),
		IF(TIME(t8.TJKELUAR) < TIME('13:00:00'),IF(TIME(t8.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('13:00:00'),60,0))) AS POTONGMAKAN,
		(t8.JAMLEMBUR -(IF((
		IF(TIME(t8.TJKELUAR) < TIME('13:00:00'),IF(TIME(t8.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('13:00:00'),60,0)))=0,
		IF(TIME(t8.TJKELUAR) < TIME('18:30:00'),IF(TIME(t8.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('18:30:00'),60,0)),
		IF(TIME(t8.TJKELUAR) < TIME('13:00:00'),IF(TIME(t8.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t8.TJKELUAR),'%i'),0),IF(TIME(t8.TJKELUAR)> TIME('13:00:00'),60,0))))) AS LEMBURBERSIH
		,t7.jenislibur as JENISLEMBUR, 1 as EXTRADAY, t8.TOTAL
		FROM kalenderlibur t7
		JOIN (
		SELECT t6.TANGGAL, t5.NIK, t5.AGAMA, t6.TJMASUK, t6.TJKELUAR,t6.TJLEMBUR, t6.JAMKERJA, t6.JAMLEMBUR, t6.TOTAL
		FROM karyawan t5
		JOIN (
		SELECT DATE_FORMAT(t1.TJMASUK,'%Y-%m-%d') as TANGGAL, t1.NIK, t1.TJMASUK, t1.TJKELUAR,t4.TJMASUK as TJLEMBUR, sum(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as JAMLEMBUR, SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
		GROUP BY t1.NIK) as t6
		ON t6.NIK=t5.NIK ) as t8
		ON t8.TANGGAL=t7.TANGGAL;
		
		SELECT t3.TANGGAL, t4.NIK, t4.TJMASUK, t4.TJKELUAR, t3.LEMBURMASUK, (TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t4.TJKELUAR)-TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t3.LEMBURMASUK)) AS JAMKERJA
FROM presensi t4
JOIN (
SELECT t2.TANGGAL, t1.NIK, t1.TJMASUK AS LEMBURMASUK, t1.TJKELUAR AS LEMBURKELUAR
FROM splembur t2
RIGHT JOIN rencanalembur t1
ON t2.NOLEMBUR=t1.NOLEMBUR) as t3
ON t3.NIK=t4.NIK AND DATE(t4.TJMASUK)=DATE(t3.LEMBURMASUK)
WHERE t3.NIK=00010427;

		
		
		* ------------------- Versi lain lembur + potong makan --------------
		SELECT DATE(t1.TJMASUK) as TANGGAL, t1.NIK, t1.TJMASUK, MAX(t1.TJKELUAR) as TJKELUAR,t4.TJMASUK as TJLEMBUR, sum(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, 
		SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as LEMBURKOTOR,
		IF((
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0)))=0,
		IF(TIME(t1.TJKELUAR) < TIME('18:30:00'),IF(TIME(t1.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('18:30:00'),60,0)),
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) -(IF((
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0)))=0,
		IF(TIME(t1.TJKELUAR) < TIME('18:30:00'),IF(TIME(t1.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('18:30:00'),60,0)),
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0))))) AS JAMLEMBUR,
		SUM(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK)
		GROUP BY t1.NIK,DATE(t1.TJMASUK);

		* -----------------
		SELECT DATE_FORMAT(t1.TJMASUK,'%Y-%m-%d') as TANGGAL, t1.NIK, t1.TJMASUK, t1.TJKELUAR,t4.TJMASUK as TJLEMBUR, (TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, (TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as LEMBURKOTOR,
		IF((
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0)))=0,
		IF(TIME(t1.TJKELUAR) < TIME('18:30:00'),IF(TIME(t1.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('18:30:00'),60,0)),
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0))) AS POTONGMAKAN,
		(SUM(TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) -(IF((
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0)))=0,
		IF(TIME(t1.TJKELUAR) < TIME('18:30:00'),IF(TIME(t1.TJKELUAR) > TIME('18:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('18:30:00'),60,0)),
		IF(TIME(t1.TJKELUAR) < TIME('13:00:00'),IF(TIME(t1.TJKELUAR) > TIME('12:00:00'),TIME_FORMAT(TIME(t1.TJKELUAR),'%i'),0),IF(TIME(t1.TJKELUAR)> TIME('13:00:00'),60,0))))) AS JAMLEMBUR,
		(TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK);


		SELECT DATE_FORMAT(t1.TJMASUK,'%Y-%m-%d') as TANGGAL, t1.NIK, t1.TJMASUK, t1.TJKELUAR,t4.TJMASUK as TJLEMBUR, (TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t4.TJMASUK)) as JAMKERJA, (TIMESTAMPDIFF(MINUTE,t4.TJMASUK,t1.TJKELUAR)) as JAMLEMBUR, (TIMESTAMPDIFF(MINUTE,t1.TJMASUK,t1.TJKELUAR)) as TOTAL
		FROM presensi t1
		JOIN (
		SELECT t3.NIK, t2.NOLEMBUR, t2.TANGGAL, t3.TJMASUK
		FROM splembur t2
		RIGHT JOIN rencanalembur t3
		ON t2.NOLEMBUR = t3.NOLEMBUR ) as t4
		ON t1.nik=t4.NIK AND date(t1.TJMASUK)=DATE(t4.TJMASUK);

		*-------------------------------------------------------------------------------
		
		* ---------------------------- ini adalah query untuk shiftjamkerja menentukan jam kurang berdasarkan SHIFT -----------
		SELECT t5.VALIDTO, t6.KODESHIFT, t6.NIK, t5.NAMASHIFT, t5.SHIFTKE, t5.JAMDARI, t5.JAMSAMPAI, ((HOUR(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))*60) + MINUTE(TIMEDIFF(t5.JAMDARI,t5.JAMSAMPAI))) as TOTALJAM, t5.TGLMULAI, t5.TGLSAMPAI
		FROM karyawanshift t6
		JOIN (
		SELECT t4.VALIDTO, t4.KODESHIFT, t1.NAMASHIFT, t1.SHIFTKE, t1.JAMDARI, t1.JAMSAMPAI, t4.TGLMULAI,t4.TGLSAMPAI
		FROM shiftjamkerja t1
		JOIN (
		SELECT t3.KODESHIFT, t2.NAMASHIFT, t3.SHIFTKE, t2.VALIDTO, t3.TGLMULAI, t3.TGLSAMPAI
		FROM shift t2
		RIGHT JOIN pembagianshift t3
		ON t2.NAMASHIFT=t3.NAMASHIFT) as t4
		ON t1.NAMASHIFT=t4.namashift AND t1.SHIFTKE=t4.SHIFTKE) as t5
		ON t5.KODESHIFT = t6.KODESHIFT AND DATE('2012-08-01') <= DATE(t5.TGLSAMPAI) AND DATE('2012-08-01') >= DATE(t5.TGLMULAI) AND T6.NIK=00010427
		* ---------------------------------------------
		
		select nik,sum(IF((480-(TIMESTAMPDIFF(MINUTE,TJMASUK,TJKELUAR)))>0,(480-(TIMESTAMPDIFF(MINUTE,TJMASUK,TJKELUAR))),0)) as JAMKURANG
		from presensi GROUP BY nik;
		
		select nik,tjmasuk,tjkeluar,(IF((480-(TIMESTAMPDIFF(MINUTE,TJMASUK,TJKELUAR)))>0,(480-(TIMESTAMPDIFF(MINUTE,TJMASUK,TJKELUAR))),0)) as JAMKURANG
		from presensi where DATE_FORMAT(TJMASUK,'%Y%m')=DATE_FORMAT(DATE_SUB('20120901',INTERVAL 1 MONTH),'%Y%m')

		insert into HITUNGPRESENSI 
		(NIK, BULAN, TANGGAL, JENISABSEN,HARIKERJA,JAMKERJA, JAMKURANG, USERNAME) 
		select NIK, '201209' as BULAN, NOW() as TANGGAL, 'AL' as JENISABSEN,
		SUM(IF(TIMESTAMPDIFF(HOUR,TJMASUK,TJKELUAR)>=8,1,0)) as HARIKERJA,
		SUM(TIMESTAMPDIFF(MINUTE,TJMASUK,TJKELUAR))as JAMKERJA, 
		SUM(IF((480-(TIMESTAMPDIFF(MINUTE,TJMASUK,TJKELUAR)))>0,(480-(TIMESTAMPDIFF(MINUTE,TJMASUK,TJKELUAR))),0)) as JAMKURANG,
		USERNAME as USERNAME 
		from PRESENSI 
		where DATE_FORMAT(TJMASUK,'%Y%m')=DATE_FORMAT(DATE_SUB('20120901',INTERVAL 1 MONTH),'%Y%m') 
		GROUP BY NIK
		*/
		
		// 1. Proses Inisialisasi Insert Record
		$sql = "insert into HITUNGPRESENSI (NIK, BULAN, TANGGAL, JENISABSEN,HARIKERJA,JAMKERJA, JAMKURANG, USERNAME) select NIK, $bulangaji as BULAN, NOW() as TANGGAL, 'AL' as JENISABSEN,SUM(IF(TIMESTAMPDIFF(HOUR,TJMASUK,TJKELUAR)>=".$TimeWork["value"].",1,0)) as HARIKERJA,SUM(TIMESTAMPDIFF(MINUTE,TJMASUK,TJKELUAR))as JAMKERJA, SUM(IF((".($TimeWork["value"]*60)."-(TIMESTAMPDIFF(MINUTE,TJMASUK,TJKELUAR)))>0,(".($TimeWork["value"]*60)."-(TIMESTAMPDIFF(MINUTE,TJMASUK,TJKELUAR))),0)) as JAMKURANG, USERNAME as USERNAME from PRESENSI where DATE_FORMAT(TJMASUK,'%Y%m')=DATE_FORMAT(DATE_SUB('$bln',INTERVAL 1 MONTH),'%Y%m') GROUP BY NIK";
		
		$query = $this->db->query($sql);
		
		// 2. Update perhitungan Presensi
		//$query = $this->db->query("SELECT NIK,SUM(IF(TIMESTAMPDIFF(HOUR,TJMASUK,TJKELUAR)>=8,1,0)) as harikerja,SUM(TIMESTAMPDIFF(MINUTE,TJmasuk,tjkeluar))as jamkerja from presensi WHERE DATE_FORMAT(tjmasuk,'%Y%m')='201208' GROUP BY NIK");
		
		$total  = $this->db->get('hitungpresensi')->num_rows();
		$last   = $this->db->select('NIK, BULAN,TANGGAL,JENISABSEN,HARIKERJA,JAMKERJA')->order_by('NIK', 'ASC')->get('hitungpresensi')->row();
		$json	= array(
						'success'   => TRUE,
						'message'   => "Data berhasil disimpan",
						'total'     => $total,
						'data'      => $last
		);
		
		return $json;
	}
	
	function get_periodegaji(){
		$sql = "SELECT periodegaji.BULAN,
				CONCAT(bulan.bulan_nama,', ',SUBSTRING(periodegaji.BULAN,1,4)) AS BULAN_GAJI,
				TGLMULAI, TGLSAMPAI
			FROM periodegaji JOIN bulan ON(bulan.bulan_kode = SUBSTRING(periodegaji.BULAN,-2))
			ORDER BY BULAN DESC";
		$query  = $this->db->query($sql)->result();
		$total  = $this->db->get('periodegaji')->num_rows();
		
		$data   = array();
		foreach($query as $result){
			$data[] = $result;
		}
		
		$json	= array(
						'success'   => TRUE,
						'message'   => "Loaded data",
						'total'     => $total,
						'data'      => $data
		);
		
		return $json;
	}
	
	function HitungPresensi($bulan,$nik, $tglmulai, $tglsampai){
		/*
		 * Langkah memproses Perhitungan Presensi untuk seluruh Karyawan		 
		 * 1. Persiapan Tabel Penunjang
		 * 1.a. Tabel PRESENSI			--> Berisi data Presensi seluruh karyawan
		 * 1.b. Tabel HITUNGPRESENSI	--> Akan Berisi data setelah proses perhitungan presensi
		 * 1.c. Tabel PERIODEGAJI		--> Berisi data penunjang dlm perhitungan bulan dlm presensi
		 * 1.d. Tabel JENISABSEN		--> Berisi data kode Jenis Absen
		 * 1.e. Tabel KARYAWANSHIFT		--> Berisi data Kode dan Nama Shift Karyawan -> berhub dgn tbel Shift
		 * 
		 * Perhitungan dilakukan Per Tanggal dari Tanggal Mulai- Tanggal SAmpai untuk setiap Karyawan...
		 *
		 * 2. Persiapan Data Perhitungan Lembur
		 * 		Lembur pada hari kerja normal
		 * 		Lembur pada hari libur sabtu minggu/nasional
		 * 		Lembur pada hari libur keagamaan
		 * Kondisi Lembur :
		 *		- Tambahkan Field JENISLEMBUR pada HITUNGPRESENSI
		 *		- Dalam list Lembur tambahkan lookup AGAMA dari NIK bersangkutan bila dia masuk pada hari liburnya agama lain.
		 *		- Tambahkan fungsi Update untuk JAMKERJA, JAMLEMBUR, EXTRADAY
		 *
		 *
		 * Kondisi Bolos :
		 *		- Persiapan data dari tabel PERMOHONANCUTI DAN RINCIANCUTI
		 *		- Persiapan data dari tabel PERMOHONANIJIN
		 *
		 *
		 * Kondisi Inisialisasi :
		 *		- Proses Inisialisasi harus Cek harinya, Apa hari Sabtu ato Minggu klo iya JenisAbsen LB -> Libur
		 *		- Persiapan data dari tabel PERMOHONANIJIN
		 *
		 *
		 *
		 *
		 *
		 * 2.a. cek db.karyawanshift => digunakan untuk mendapatkan KODESHIFT
		 * 2.b. cek db.pembagianshift => Untuk mendapatkan NAMASHIFT SHIFTKE TGLMULAI, TGLSAMPAI
		 * 2.c. cek db.shiftjamkerja => Untuk mendapatkan JAMDARI JAMSAMPAI
		 * * 
		 * 3. Persiapan Data perhitungan Lembur dan ExtraDay
		 * 3.a. cek db.splembur => apakah ada perintah surat lembur untuk menentukan jam lembur
		 * 3.b. cek db.rencanalembur => apakah ada perintah surat lembur untuk menentukan jam lembur
		 * 3.c. cek db.kalenderlibur => apakah karyawan bekerja pada hari libur atau tidak untuk menentukan ExtraDay...
		 * 
		 */
		 
		/* 2.a. */
		$kodeshift = $this->db->get_where('karyawanshift', array('NIK'=>$nik));
		if($kodeshift->num_rows() == 0){
			$kodeshift = $this->db->get_where('karyawanshift', array('NIK'=>$nik));
		}
		
	}
	
	function getAll($start, $page, $limit){
		$sql = "SELECT h.NIK, k.NAMAKAR as NAMA, h.BULAN, h.TANGGAL, h.JENISABSEN, h.HARIKERJA, h.JAMKERJA, h.JAMLEMBUR, h.JAMKURANG, h.JAMBOLOS,
		h.EXTRADAY, h.TERLAMBAT, h.PLGLBHAWAL, h.USERNAME, h.POSTING
		FROM hitungpresensi h
		INNER JOIN karyawan k ON k.NIK=h.NIK
		ORDER BY h.TANGGAL ASC
		LIMIT $start,$limit";
		$query = $this->db->query($sql)->result();
		//$query  = $this->db->limit($limit, $start)->order_by('TANGGAL', 'ASC')->get('hitungpresensi')->result();
		$total  = $this->db->get('hitungpresensi')->num_rows();
		
		$data   = array();
		foreach($query as $result){
			$data[] = $result;
		}
		
		$json	= array(
						'success'   => TRUE,
						'message'   => "Loaded data",
						'total'     => $total,
						'data'      => $data
		);
		
		return $json;
	}
	
	/**
	 * Fungsi	: save
	 * 
	 * Untuk menambah data baru atau mengubah data lama
	 * 
	 * @param array $data
	 * @return json
	 */
	function save($data){
		$last   = NULL;
		
		$pkey = array('NIK'=>$data->NIK,'BULAN'=>$data->BULAN,'TANGGAL'=>date('Y-m-d', strtotime($data->TANGGAL)));
		
		if($this->db->get_where('hitungpresensi', $pkey)->num_rows() > 0){
			/*
			 * Data Exist
			 */
			
			$arrdatau = array('JENISABSEN'=>$data->JENISABSEN,'HARIKERJA'=>$data->HARIKERJA,'JAMKERJA'=>$data->JAMKERJA,'JAMLEMBUR'=>$data->JAMLEMBUR,'JAMKURANG'=>$data->JAMKURANG,'JAMBOLOS'=>$data->JAMBOLOS,'EXTRADAY'=>$data->EXTRADAY,'TERLAMBAT'=>$data->TERLAMBAT,'PLGLBHAWAL'=>$data->PLGLBHAWAL,'USERNAME'=>$data->USERNAME,'POSTING'=>$data->POSTING);
			 
			$this->db->where($pkey)->update('hitungpresensi', $arrdatau);
			$last   = $data;
			
		}else{
			/*
			 * Data Not Exist
			 * 
			 * Process Insert
			 */
			
			$arrdatac = array('NIK'=>$data->NIK,'BULAN'=>$data->BULAN,'TANGGAL'=>(strlen(trim($data->TANGGAL)) > 0 ? date('Y-m-d', strtotime($data->TANGGAL)) : NULL),'JENISABSEN'=>$data->JENISABSEN,'HARIKERJA'=>$data->HARIKERJA,'JAMKERJA'=>$data->JAMKERJA,'JAMLEMBUR'=>$data->JAMLEMBUR,'JAMKURANG'=>$data->JAMKURANG,'JAMBOLOS'=>$data->JAMBOLOS,'EXTRADAY'=>$data->EXTRADAY,'TERLAMBAT'=>$data->TERLAMBAT,'PLGLBHAWAL'=>$data->PLGLBHAWAL,'USERNAME'=>$data->USERNAME,'POSTING'=>$data->POSTING);
			 
			$this->db->insert('hitungpresensi', $arrdatac);
			$last   = $this->db->where($pkey)->get('hitungpresensi')->row();
			
		}
		
		$total  = $this->db->get('hitungpresensi')->num_rows();
		
		$json   = array(
						"success"   => TRUE,
						"message"   => 'Data berhasil disimpan',
						"total"     => $total,
						"data"      => $last
		);
		
		return $json;
	}
	
	/**
	 * Fungsi	: delete
	 * 
	 * Untuk menghapus satu data
	 * 
	 * @param array $data
	 * @return json
	 */
	function delete($data){
		$pkey = array('NIK'=>$data->NIK,'BULAN'=>$data->BULAN,'TANGGAL'=>date('Y-m-d', strtotime($data->TANGGAL)));
		
		$this->db->where($pkey)->delete('hitungpresensi');
		
		$total  = $this->db->get('hitungpresensi')->num_rows();
		$last = $this->db->get('hitungpresensi')->result();
		
		$json   = array(
						"success"   => TRUE,
						"message"   => 'Data berhasil dihapus',
						"total"     => $total,
						"data"      => $last
		);				
		return $json;
	}
	
	/*function getAll($tglmulai, $tglsampai,$saring,$sort,$filters,$start, $page, $limit){
		if($saring == "Range" && $filters == null)
		{
			$sql = "SELECT h.NIK, k.NAMAKAR as NAMA, h.BULAN, h.TANGGAL, h.JENISABSEN, h.HARIKERJA, h.JAMKERJA, h.JAMLEMBUR, h.JAMKURANG, h.JAMBOLOS,
			h.EXTRADAY, h.TERLAMBAT, h.PLGLBHAWAL, h.USERNAME, h.POSTING
			FROM hitungpresensi h
			INNER JOIN karyawan k ON k.NIK=h.NIK
			WHERE h.TANGGAL >= DATE('$tglmulai') AND h.TANGGAL <= DATE('$tglsampai')";
			$sql .= " ORDER BY k.NAMAKAR ASC";
			//$sql .= " LIMIT ".$start.",".$limit;		
			$query = $this->db->query($sql);
			
			//$this->db->where('TJKELUAR IS NULL', NULL);
			//$this->db->or_where('TJMASUK = TJKELUAR', NULL); 
			//$query  = $this->db->limit($limit, $start)->order_by('TJMASUK', 'ASC')->get('presensi');
			$total  = $query->num_rows();
			
			$data   = array();
			foreach($query->result() as $result){
				$data[] = $result;
			}
			
			$json	= array(
				'success'   => TRUE,
				'message'   => "Loaded data",
				'total'     => $total,
				'data'      => $data
			);
			
			return $json;
		}
		else
		{
			if (is_array($sorts)) {
				$encoded = false;
			} else {
				$encoded = true;
				$sorts = json_decode($sorts);
			}
			$dsort = ' h.NIK ASC';
			$ks = '';
			
			if (is_array($sorts)) {
				for ($i=0;$i<count($sorts);$i++){
					$sort = $sorts[$i];

					// assign Sort data (location depends if encoded or not)
					if ($encoded) {
						if($sort->property == 'NIK')
							$prop = "h.".$sort->property;
						elseif($sort->property == 'NAMAKAR')
							$prop = "k.".$sort->property;
						elseif($sort->property == 'NAMAUNIT')
							$prop = "uk.".$sort->property;
						elseif($sort->property == 'NAMAKEL')
							$prop = "kk.".$sort->property;
						else if($sort->property == 'TANGGAL')
							$prop = "h.".$sort->property;
						elseif($sort->property == 'TJMASUK')
							$prop = "h.".$sort->property;
						elseif($sort->property == 'TJKELUAR')
							$prop = "h.".$sort->property;
						else
							$prop = $sort->property;
						
						$dir = $sort->direction;					
					} else {
						$prop = $sort['property'];
						$dir = $sort['direction'];
					}
					$ks .= ",".$prop." ".$dir;
				}
				$dsort .= $ks;
			}
			//$this->firephp->info($dsort);

			// GridFilters sends filters as an Array if not json encoded
			if (is_array($filters)) {
				$encoded = false;
			} else {
				$encoded = true;
				$filters = json_decode($filters);
			}

			$where = ' 0 = 0 ';
			$qs = '';

			// loop through filters sent by client
			if (is_array($filters)) {
				for ($i=0;$i<count($filters);$i++){
					$filter = $filters[$i];

					// assign filter data (location depends if encoded or not)
					if ($encoded) {
						if($filter->field == 'NIK')
							$field = "h.".$filter->field;
						else
							$field = $filter->field;
							
						$value = $filter->value;
						$compare = isset($filter->comparison) ? $filter->comparison : null;
						$filterType = $filter->type;
					} else {
						$field = $filter['field'];
						$value = $filter['data']['value'];
						$compare = isset($filter['data']['comparison']) ? $filter['data']['comparison'] : null;
						$filterType = $filter['data']['type'];
					}

					switch($filterType){
						case 'string' : $qs .= " AND ".$field." LIKE '%".$value."%'"; Break;
						case 'list' :
							if (strstr($value,',')){
								$fi = explode(',',$value);
								for ($q=0;$q<count($fi);$q++){
									$fi[$q] = "'".$fi[$q]."'";
								}
								$value = implode(',',$fi);
								$qs .= " AND ".$field." IN (".$value.")";
							}else{
								$qs .= " AND ".$field." = '".$value."'";
							}
						Break;
						case 'boolean' : $qs .= " AND ".$field." = ".($value); Break;
						case 'numeric' :
							switch ($compare) {
								case 'eq' : $qs .= " AND ".$field." = ".$value; Break;
								case 'lt' : $qs .= " AND ".$field." < ".$value; Break;
								case 'gt' : $qs .= " AND ".$field." > ".$value; Break;
							}
						Break;
						case 'date' :
							switch ($compare) {
								case 'eq' : $qs .= " AND ".$field." = '".date('Y-m-d',strtotime($value))."'"; Break;
								case 'lt' : $qs .= " AND ".$field." < '".date('Y-m-d',strtotime($value))."'"; Break;
								case 'gt' : $qs .= " AND ".$field." > '".date('Y-m-d',strtotime($value))."'"; Break;
							}
						Break;
						case 'datetime' :
							switch ($compare) {
								case 'eq' : $qs .= " AND ".$field." = '".date('Y-m-d H:i:s',strtotime($value))."'"; Break;
								case 'lt' : $qs .= " AND ".$field." < '".date('Y-m-d H:i:s',strtotime($value))."'"; Break;
								case 'gt' : $qs .= " AND ".$field." > '".date('Y-m-d H:i:s',strtotime($value))."'"; Break;
							}
						Break;
					}
				}
				$where .= $qs;
			}
			
			$sql = "SELECT h.NIK, k.NAMAKAR as NAMA, h.BULAN, h.TANGGAL, h.JENISABSEN, h.HARIKERJA, h.JAMKERJA, h.JAMLEMBUR, h.JAMKURANG, h.JAMBOLOS,
			h.EXTRADAY, h.TERLAMBAT, h.PLGLBHAWAL, h.USERNAME, h.POSTING
			FROM hitungpresensi h
			INNER JOIN karyawan k ON k.NIK=h.NIK
			WHERE ".$where;
			
			$sql .= " ORDER BY ".$dsort;
			$sql .= " LIMIT ".$start.",".$limit;		
			$query = $this->db->query($sql)->result();
			//$total = $query->num_rows();
			
			$total  = $this->db->query("SELECT count(h.NIK) AS total, k.NAMAKAR as NAMA, h.BULAN, h.TANGGAL, h.JENISABSEN, h.HARIKERJA, h.JAMKERJA, h.JAMLEMBUR, h.JAMKURANG, h.JAMBOLOS,
			h.EXTRADAY, h.TERLAMBAT, h.PLGLBHAWAL, h.USERNAME, h.POSTING
			FROM hitungpresensi h
			INNER JOIN karyawan k ON k.NIK=h.NIK WHERE ".$where)->result();
			$data   = array();
			foreach($query as $result){
				$data[] = $result;
			}
			//$this->firephp->info($sql);
			$json	= array(
				'success'   => TRUE,
				'message'   => "Loaded data",
				'total'     => $total[0]->total,
				//'total'     => $total,
				'data'      => $data
			);
			
			return $json;
		}
	}*/
	
	function getAllData($tglmulai, $tglsampai,$saring,$sorts,$filters,$start, $page, $limit)
	{	
		if($saring == "Range" && $filters == null)
		{
			$sql = "SELECT h.NIK, k.NAMAKAR, uk.NAMAUNIT, kk.NAMAKEL, h.BULAN, h.TANGGAL, h.JENISABSEN,
			h.HARIKERJA, h.JAMKERJA, h.JENISLEMBUR, h.JAMLEMBUR, h.SATLEMBUR, h.JAMKURANG,
			h.JAMBOLOS, h.IZINPRIBADI,
			h.EXTRADAY, h.TERLAMBAT, h.PLGLBHAWAL, h.USERNAME, h.POSTING
			FROM hitungpresensi h
			INNER JOIN karyawan k ON k.NIK=h.NIK
			INNER JOIN unitkerja uk ON uk.KODEUNIT=k.KODEUNIT
			INNER JOIN kelompok	kk ON kk.KODEKEL=uk.KODEKEL
			WHERE h.TANGGAL >= DATE('$tglmulai') AND h.TANGGAL <= DATE('$tglsampai')";
			$sql .= " ORDER BY k.NAMAKAR ASC";
			//$sql .= " LIMIT ".$start.",".$limit;		
			$query = $this->db->query($sql);
			
			//$this->db->where('TJKELUAR IS NULL', NULL);
			//$this->db->or_where('TJMASUK = TJKELUAR', NULL); 
			//$query  = $this->db->limit($limit, $start)->order_by('TJMASUK', 'ASC')->get('presensi');
			$total  = $query->num_rows();
			
			$data   = array();
			foreach($query->result() as $result){
				$data[] = $result;
			}
			
			$json	= array(
				'success'   => TRUE,
				'message'   => "Loaded data",
				'total'     => $total,
				'data'      => $data
			);
			
			return $json;
		}
		else
		{
			if (is_array($sorts)) {
					$encoded = false;
				} else {
					$encoded = true;
					$sorts = json_decode($sorts);
				}
				$dsort = ' h.NIK ASC';
				$ks = '';
				
				if (is_array($sorts)) {
					for ($i=0;$i<count($sorts);$i++){
						$sort = $sorts[$i];

						// assign Sort data (location depends if encoded or not)
						if ($encoded) {
							if($sort->property == 'NIK')
								$prop = "h.".$sort->property;
							elseif($sort->property == 'NAMAKAR')
								$prop = "k.".$sort->property;
							elseif($sort->property == 'NAMAUNIT')
								$prop = "uk.".$sort->property;
							elseif($sort->property == 'NAMAKEL')
								$prop = "kk.".$sort->property;
							else if($sort->property == 'TANGGAL')
								$prop = "h.".$sort->property;
							elseif($sort->property == 'TJMASUK')
								$prop = "h.".$sort->property;
							elseif($sort->property == 'TJKELUAR')
								$prop = "h.".$sort->property;
							else
								$prop = $sort->property;
							
							$dir = $sort->direction;					
						} else {
							$prop = $sort['property'];
							$dir = $sort['direction'];
						}
						$ks .= ",".$prop." ".$dir;
					}
					$dsort .= $ks;
				}
			// GridFilters sends filters as an Array if not json encoded
			if (is_array($filters)) {
				$encoded = false;
			} else {
				$encoded = true;
				$filters = json_decode($filters);
			}

			$where = ' 0 = 0 ';
			$qs = '';

			// loop through filters sent by client
			if (is_array($filters)) {
				for ($i=0;$i<count($filters);$i++){
					$filter = $filters[$i];

					// assign filter data (location depends if encoded or not)
					if ($encoded) {
						if($filter->field == 'NIK')
							$field = "h.".$filter->field;
						else
							$field = $filter->field;
							
						$value = $filter->value;
						$compare = isset($filter->comparison) ? $filter->comparison : null;
						$filterType = $filter->type;
					} else {
						$field = $filter['field'];
						$value = $filter['data']['value'];
						$compare = isset($filter['data']['comparison']) ? $filter['data']['comparison'] : null;
						$filterType = $filter['data']['type'];
					}

					switch($filterType){
						case 'string' : $qs .= " AND ".$field." LIKE '%".$value."%'"; Break;
						case 'list' :
							if (strstr($value,',')){
								$fi = explode(',',$value);
								for ($q=0;$q<count($fi);$q++){
									$fi[$q] = "'".$fi[$q]."'";
								}
								$value = implode(',',$fi);
								$qs .= " AND ".$field." IN (".$value.")";
							}else{
								$qs .= " AND ".$field." = '".$value."'";
							}
						Break;
						case 'boolean' : $qs .= " AND ".$field." = ".($value); Break;
						case 'numeric' :
							switch ($compare) {
								case 'eq' : $qs .= " AND ".$field." = ".$value; Break;
								case 'lt' : $qs .= " AND ".$field." < ".$value; Break;
								case 'gt' : $qs .= " AND ".$field." > ".$value; Break;
							}
						Break;
						case 'date' :
							switch ($compare) {
								case 'eq' : $qs .= " AND ".$field." = '".date('Y-m-d',strtotime($value))."'"; Break;
								case 'lt' : $qs .= " AND ".$field." < '".date('Y-m-d',strtotime($value))."'"; Break;
								case 'gt' : $qs .= " AND ".$field." > '".date('Y-m-d',strtotime($value))."'"; Break;
							}
						Break;
						case 'datetime' :
							switch ($compare) {
								case 'eq' : $qs .= " AND ".$field." = '".date('Y-m-d H:i:s',strtotime($value))."'"; Break;
								case 'lt' : $qs .= " AND ".$field." < '".date('Y-m-d H:i:s',strtotime($value))."'"; Break;
								case 'gt' : $qs .= " AND ".$field." > '".date('Y-m-d H:i:s',strtotime($value))."'"; Break;
							}
						Break;
					}
				}
				$where .= $qs;
			}
			
			$sql = "SELECT h.NIK, k.NAMAKAR, uk.NAMAUNIT, kk.NAMAKEL, h.BULAN, h.TANGGAL, h.JENISABSEN,
			h.HARIKERJA, h.JAMKERJA, h.JENISLEMBUR, h.JAMLEMBUR, h.SATLEMBUR, h.JAMKURANG,
			h.JAMBOLOS, h.IZINPRIBADI,
			h.EXTRADAY, h.TERLAMBAT, h.PLGLBHAWAL, h.USERNAME, h.POSTING
			FROM hitungpresensi h
			INNER JOIN karyawan k ON k.NIK=h.NIK
			INNER JOIN unitkerja uk ON uk.KODEUNIT=k.KODEUNIT
			INNER JOIN kelompok	kk ON kk.KODEKEL=uk.KODEKEL
			WHERE ".$where;
			
			//$sql .= " ORDER BY k.NAMAKAR ASC";
			$sql .= " ORDER BY ".$dsort;
			$sql .= " LIMIT ".$start.",".$limit;		
			$query = $this->db->query($sql)->result();
			//$total = $query->num_rows();
			
			$total  = $this->db->query("SELECT count(h.NIK) as total, k.NAMAKAR, uk.NAMAUNIT, uk.KODEKEL, h.BULAN, h.TANGGAL, h.JENISABSEN,
			h.HARIKERJA, h.JAMKERJA, h.JENISLEMBUR, h.JAMLEMBUR, h.SATLEMBUR, h.JAMKURANG,
			h.JAMBOLOS, h.IZINPRIBADI,
			h.EXTRADAY, h.TERLAMBAT, h.PLGLBHAWAL, h.USERNAME, h.POSTING
			FROM hitungpresensi h
			INNER JOIN karyawan k ON k.NIK=h.NIK
			INNER JOIN unitkerja uk ON uk.KODEUNIT=k.KODEUNIT WHERE ".$where)->result();
			$data   = array();
			foreach($query as $result){
				$data[] = $result;
			}
			//$this->firephp->info($sql);
			$json	= array(
				'success'   => TRUE,
				'message'   => "Loaded data",
				'total'     => $total[0]->total,
				//'total'     => $total,
				'data'      => $data
			);
			
			return $json;
		}
	}
}
?>